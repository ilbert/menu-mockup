<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menu Mockup - Test de usabilidad</title>
  <style>
    :root{
      --brand:#034ca8;
      --brand2:#0b5bd3;
      --border:#e6e8eb;
      --bg:#f4f6f9;

      --warnBg:#fff7e6;
      --warnText:#8a4b00;
      --warnBorder:#ffb020;

      --shadow:0 24px 60px rgba(0,0,0,.18);
      --shadow2:0 14px 30px rgba(0,0,0,.16);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      overflow:hidden;
      color:#0f172a;
      -webkit-text-size-adjust:100%;
    }

    header{
      background:#fff;
      height:60px;
      display:flex;
      align-items:center;
      padding:0 16px;
      border-bottom:1px solid var(--border)
    }

    .hamburger{
      width:44px;height:44px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      border-radius:12px;
      font-size:20px;
      color:var(--brand)
    }

    #overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1000}
    #drawer{
      position:fixed;inset:0 auto 0 0;background:#fff;z-index:1001;display:none;
      flex-direction:column;box-shadow:10px 0 30px rgba(0,0,0,.12);width:auto;max-width:96vw
    }
    .drawer-header{
      padding:14px 16px;border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;font-weight:900;color:var(--brand)
    }
    .close-x{border:none;background:none;cursor:pointer;font-size:18px;line-height:1}

    #status{padding:10px;text-align:center;font-size:12px;background:#fff3cd;display:none}

    #columns-container{
      display:flex;flex:1;
      overflow-x:auto;overflow-y:hidden;background:#fff;
      scrollbar-width:none;-ms-overflow-style:none;
      -webkit-overflow-scrolling:touch;
    }

    .column{flex:0 0 330px;border-right:1px solid #eee;overflow-y:auto;height:100%}
    @media (max-width:520px){
      .column{flex-basis:86vw}
    }

    ul{list-style:none;padding:0;margin:0}
    .item{
      padding:14px 16px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      cursor:pointer;font-size:14px;border-bottom:1px solid #f3f4f6;
      transition:background .12s ease, color .12s ease;
      -webkit-tap-highlight-color:transparent;
    }
    .item:hover{background:#f7f9fc;color:var(--brand)}

    /* ‚úÖ Selecci√≥n normal en azul */
    .item.active{
      background:#e6f2fa;
      color:var(--brand);
      font-weight:900;
      border-left:5px solid var(--brand)
    }

    .label{display:flex;align-items:center;gap:10px;min-width:0}
    .text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .icon{width:22px;height:22px;display:inline-grid;place-items:center;font-size:18px;flex:0 0 auto}
    .chevron{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;flex:0 0 auto}
    .chevron svg{width:18px;height:18px;stroke:var(--brand);stroke-width:2.6;fill:none;stroke-linecap:round;stroke-linejoin:round}
    .column-header{
      padding:14px 14px 8px;font-weight:900;color:var(--brand);
      font-size:18px;display:flex;align-items:center;gap:10px
    }
    .back-only{border:none;background:transparent;padding:0;cursor:pointer;display:inline-flex;align-items:center}
    .divider{border-top:1px solid #e5e7eb;margin:8px 0;}

    code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .btn{
      padding:14px 18px;border-radius:16px;border:1px solid var(--border);
      font-weight:1000;cursor:pointer;font-size:14px;
      transition:transform .06s ease, filter .12s ease;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .btn:active{ transform:translateY(1px); }
    .btnPrimary{background:linear-gradient(180deg, var(--brand2), var(--brand));color:#fff;border-color:transparent;}
    .btnWarn{background:linear-gradient(180deg, #ffcf6b, #ffb020);border-color:transparent;color:#3a2400;}
    .btnDanger{background:linear-gradient(180deg, #ff6b6b, #e11d48);border-color:transparent;color:#fff;}

    .chip{
      display:inline-flex;align-items:center;gap:8px;
      background:#eef4ff;border:1px solid #d7e4ff;color:#123e8f;
      padding:6px 12px;border-radius:999px;font-weight:1000;font-size:12px;
    }
    .card{
      border:1px solid var(--border);
      border-radius:22px;
      background:#fff;
      box-shadow:var(--shadow);
    }

    #confettiCanvas{ position:fixed; inset:0; z-index:9999; pointer-events:none; display:none; }

    .spinner{
      width:34px;height:34px;border-radius:50%;
      border:4px solid #dbe7ff;border-top-color: var(--brand);
      animation:spin 1s linear infinite;
      margin:0 auto;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ‚úÖ Si hay desv√≠os: naranja SOLO el activo */
    #drawer.struggling .item.active{
      background:var(--warnBg) !important;
      color:var(--warnText) !important;
      border-left:5px solid var(--warnBorder) !important;
      font-weight:1000 !important;
    }
    .item.found-warn{
      background:var(--warnBg) !important;
      color:var(--warnText) !important;
      border-left:5px solid var(--warnBorder) !important;
      font-weight:1000 !important;
    }

    /* ===== TAGS ===== */
    .tag{font-size:11px;font-weight:1000;padding:2px 8px;border-radius:999px;margin-left:8px;white-space:nowrap}
    .tag.new{background:#e6f2fa;color:var(--brand)}
    .tag.trending{background:#eafaf1;color:#0a8f4e}

    /* ===== BANNERS ===== */
    .promo-card{ margin:16px; border-radius:14px; overflow:hidden; position:relative; background:#f0f0f0; box-shadow:0 10px 25px rgba(0,0,0,.1); }
    .promo-img{ width:100%; height:160px; object-fit:cover; display:block; }
    .promo-link{ position:absolute; inset:0; display:block; }
    .promo-card.small{ margin:12px 16px 8px; }
    .promo-card.small .promo-img{ height:120px; }

    /* ===== MODALES ===== */
    .modalOverlay{
      position:fixed; inset:0;
      background:linear-gradient(180deg, rgba(3,76,168,.55), rgba(0,0,0,.55));
      display:none;
      z-index:4000;
      padding:16px;
    }
    .modalCard{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:min(980px, 92vw);
      padding:22px;
    }

    .introGrid{
      display:grid;
      grid-template-columns:1.1fr .9fr;
      gap:16px;
      margin-top:18px;
    }
    .introCta{
      display:flex;
      justify-content:center;
      margin-top:18px;
    }
    .introBtn{
      min-width:min(560px,92vw);
      font-size:18px;
      padding:18px 24px;
      border-radius:18px;
    }

    /* ===== PANEL EN CURSO ‚Äî SOLO BOTONES ===== */
    #abpanel{
      position:fixed;
      top:12px; right:12px;
      z-index:2000;
      padding:12px;
      width:340px; max-width:92vw;
      display:none;
      border-radius:18px;
      box-shadow:var(--shadow2);
      background:#fff;
      border:1px solid var(--border);
    }
    .panelTitle{
      font-weight:1000;
      color:#0b1b3a;
      font-size:13px;
      margin-bottom:10px;
      display:flex;align-items:center;gap:8px;
    }
    .panelTitle .dot{
      width:10px;height:10px;border-radius:999px;background:#16a34a;box-shadow:0 0 0 4px rgba(22,163,74,.15);
    }
    .panelBtns{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    /* ===== M√ìVIL ===== */
    @media (max-width:720px){
      body{ overflow:auto; }

      .modalOverlay{ padding:0; }
      .modalCard{
        position:fixed;
        left:0; top:0;
        transform:none;
        width:100vw;
        height:100vh;
        border-radius:0;
        padding:16px 14px;
        overflow:auto;
        box-shadow:none;
        border:none;
      }

      .introModal{
        display:flex;
        flex-direction:column;
        height:100vh;
        overflow:hidden;
      }
      .introGrid{
        grid-template-columns:1fr;
        gap:12px;
      }
      .introModal .introGrid{
        flex:1;
        overflow:auto;
        padding-bottom:110px;
      }

      .introCta{
        position:fixed;
        left:0; right:0; bottom:0;
        z-index:9999;
        padding:12px 14px calc(12px + env(safe-area-inset-bottom));
        background:rgba(244,246,249,.92);
        backdrop-filter: blur(10px);
        border-top:1px solid var(--border);
      }
      .introBtn{
        width:min(560px, 92vw);
        padding:16px 22px;
        font-size:18px;
        border-radius:18px;
      }

      /* Panel abajo compacto */
      #abpanel{
        top:auto; right:0; left:0; bottom:0;
        width:100vw; max-width:100vw;
        border-radius:18px 18px 0 0;
        padding:10px 12px calc(10px + env(safe-area-inset-bottom));
        box-shadow:0 -16px 40px rgba(0,0,0,.18);
      }
      #abpanel .btn{
        padding:12px 14px !important;
        font-size:16px !important;
        border-radius:16px !important;
      }

      #drawer{ max-width:100vw; padding-bottom:132px; }
      #columns-container{ padding-bottom:132px; }
    }
  </style>
</head>
<body>

<canvas id="confettiCanvas"></canvas>

<header>
  <button class="hamburger" id="openBtn">‚ò∞</button>
  <div style="margin-left:12px;font-weight:1000;color:var(--brand);letter-spacing:.2px;">MENU MOCKUP</div>
</header>

<!-- ===== INICIO ===== -->
<div id="taskIntroOverlay" class="modalOverlay">
  <div class="card modalCard introModal">
    <div style="display:flex;align-items:flex-start;gap:14px;">
      <div style="
        width:52px;height:52px;border-radius:18px;
        background:linear-gradient(180deg, var(--brand2), var(--brand));
        display:grid;place-items:center;color:#fff;font-weight:1000;font-size:16px;">
        UX
      </div>

      <div style="flex:1;">
        <div class="chip">Test de usabilidad del men√∫ web</div>
        <div style="margin-top:10px;font-weight:1000;font-size:clamp(28px, 4.2vw, 40px);color:#0b1b3a;line-height:1.06;">
          Test de usabilidad del men√∫ web
        </div>
        <div style="margin-top:12px;color:#334155;line-height:1.7;font-size:clamp(15px, 2.4vw, 18px);max-width:90ch;">
          Vas a realizar <b>3 tareas</b> de encontrabilidad: encontrar categor√≠as dentro del men√∫.
          <b>El cron√≥metro empieza</b> cuando pulses ‚ÄúComenzar tarea‚Äù.
        </div>
      </div>
    </div>

    <div class="introGrid">
      <div style="border:1px solid var(--border);border-radius:18px;padding:16px;background:#fbfcfe;">
        <div style="font-weight:1000;color:#0f172a;font-size:16px;">Qu√© tienes que hacer</div>
        <ol style="margin:12px 0 0 20px;color:#334155;line-height:1.9;font-size:clamp(14px, 2.2vw, 16px);">
          <li>Pulsa <b>Empezar</b>.</li>
          <li>Lee la tarea y pulsa <b>Comenzar tarea</b>.</li>
          <li>Navega hasta la <b>ruta correcta</b>.</li>
          <li>Si te interrumpen, usa <b>Pausa</b> y luego <b>Reanudar</b>.</li>
          <li>Al finalizar, se descargar√° un <b>Excel</b> autom√°ticamente.</li>
        </ol>
        <div style="margin-top:10px;color:#64748b;font-size:13px;">
          Consejo: navega como lo har√≠as normalmente en una web real.
        </div>
      </div>

      <div style="border:1px solid var(--border);border-radius:18px;padding:16px;background:#fff;">
        <div style="font-weight:1000;color:#0f172a;font-size:16px;">Tareas incluidas</div>
        <ul id="introTaskList" style="margin:12px 0 0 20px;color:#334155;line-height:1.9;font-size:clamp(14px, 2.2vw, 16px);"></ul>
      </div>
    </div>

    <div class="introCta">
      <button id="btnIntroStart" class="btn btnPrimary introBtn">Empezar</button>
    </div>
  </div>
</div>

<!-- ===== INSTRUCCIONES DE TAREA ===== -->
<div id="nextTaskOverlay" class="modalOverlay" style="z-index:3500;">
  <div class="card modalCard" style="text-align:center; width:min(900px,92vw);">
    <div class="chip">Siguiente tarea</div>
    <div id="nextTitle" style="margin-top:10px;font-weight:1000;font-size:clamp(18px, 3vw, 24px);color:#0b1b3a;"></div>

    <div style="margin-top:14px;border:1px solid var(--border);border-radius:18px;padding:16px;background:#fbfcfe; text-align:left;">
      <div id="nextGoal" style="color:#0f172a;font-size:clamp(14px, 2.2vw, 16px);line-height:1.65;"></div>
      <div id="nextInfo" style="margin-top:10px;color:#475569;line-height:1.65;font-size:clamp(14px, 2.2vw, 16px);"></div>
      <div id="nextRoute" style="margin-top:12px;color:#0f172a;font-size:13px;">
        <b>Ruta objetivo:</b>
        <code style="background:#fff;border:1px solid var(--border);padding:4px 8px;border-radius:10px;"></code>
      </div>
    </div>

    <div style="display:flex;justify-content:center;margin-top:18px;">
      <button id="btnStartThisTask" class="btn btnPrimary" style="min-width:min(560px,92vw);font-size:18px;padding:18px 24px;border-radius:18px;">
        Comenzar tarea
      </button>
    </div>

    <div style="margin-top:10px;color:#94a3b8;font-size:13px;">
      El cron√≥metro empezar√° al pulsar ‚ÄúComenzar tarea‚Äù.
    </div>
  </div>
</div>

<!-- ===== FINAL ===== -->
<div id="finalOverlay" class="modalOverlay" style="z-index:5000; background:linear-gradient(180deg, rgba(3,76,168,.65), rgba(0,0,0,.60));">
  <div class="card modalCard" style="text-align:center; width:min(760px,92vw);">
    <div class="chip">Test finalizado</div>
    <div style="margin-top:10px;font-weight:1000;font-size:clamp(20px, 3.5vw, 28px);color:#0b1b3a;">‚úÖ Test finalizado</div>
    <div id="finalSubtitle" style="margin-top:10px;color:#334155;font-size:clamp(14px, 2.2vw, 16px);line-height:1.6;">Estamos preparando tu archivo Excel‚Ä¶</div>
    <div style="margin-top:16px;"><div class="spinner" id="finalSpinner"></div></div>
  </div>
</div>

<!-- ===== PANEL EN CURSO (solo botones) ===== -->
<div id="abpanel" class="card">
  <div class="panelTitle"><span class="dot"></span> Test en curso</div>
  <div class="panelBtns">
    <button id="btnPause" class="btn btnWarn" style="width:100%;">‚è∏ Pausa</button>
    <button id="btnResume" class="btn btnPrimary" style="width:100%;display:none;">‚ñ∂ Reanudar</button>
    <button id="btnFailTask" class="btn btnDanger" style="width:100%;">No lo encuentro</button>
  </div>
</div>

<!-- ===== COMPLETADO ===== -->
<div id="doneOverlay" style="position:fixed; inset:0; z-index:3000; display:none; background:rgba(0,0,0,.55); padding:16px;">
  <div class="card" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(620px,92vw); padding:20px; text-align:center;">
    <div id="doneTitle" style="font-weight:1000;font-size:20px;color:#0b1b3a;">‚úÖ Resultado</div>
    <div id="doneDetail" style="margin-top:10px;color:#334155;font-size:14px; white-space:pre-line;line-height:1.55;"></div>
    <div id="doneTime" style="margin-top:12px;font-weight:1000;font-size:16px;"></div>
    <div style="display:flex; gap:10px; margin-top:16px;">
      <button id="btnNextTask" class="btn btnPrimary" style="flex:1;border-radius:18px;">Siguiente</button>
    </div>
  </div>
</div>

<div id="overlay"></div>

<aside id="drawer">
  <div class="drawer-header">
    <span>MENU</span>
    <button class="close-x" id="closeBtn">‚úï</button>
  </div>
  <div id="status"></div>
  <div id="columns-container"></div>
</aside>

<script>
  // ====== Datos categor√≠as + banners (CSV de Google Sheets) ======
  const SHEET_ID = "1rG-kDB8Srrn-dIldsFuc7rwAc7q2EuNy4CHfz2kvDTY";
  const GID_CATEGORIES = "0";
  const GID_BANNERS = "1300813141";

  const DATA_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_CATEGORIES}&_=${Date.now()}`;
  const BANNERS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_BANNERS}&_=${Date.now()}`;

  const CHEVRON_SVG = `<span class="chevron"><svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg></span>`;
  const BACK_CHEVRON_SVG = `<span class="chevron" style="transform:rotate(180deg)"><svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg></span>`;

  const TOP_ORDER = ["Camillas", "Mobiliario", "Sillas de ruedas", "Aparatolog√≠a y equipos", "Esterilizaci√≥n y autoclaves", "Material m√©dico", "Cuidado personal y salud", "Desechables y consumibles", "Ayudas t√©cnicas para personas mayores", "Vestuario y seguridad"];
  const ICON_MAP = {"aparatologia y equipos":"üìÅ", "ayudas tecnicas para personas mayores":"üßì", "camillas":"üõèÔ∏è", "cuidado personal y salud":"üß¥", "desechables y consumibles":"üßª", "diagnostico":"ü©∫", "esterilizacion y autoclaves":"üßº", "instrumental":"üß∞", "material medico":"üì¶", "mobiliario":"ü™ë", "sillas de ruedas":"ü¶Ω", "vestuario y seguridad":"ü¶∫"};

  const FEATURED_CATS = [
    { name:"Camillas", tag:"trending" },
    { name:"Sillas de ruedas", tag:"new" },
    { name:"Diagn√≥stico", tag:null },
    { name:"Mobiliario", tag:null }
  ];

  const SPECIALTIES_ITEMS = [
    { name:"Fisioterapia", icon:"ü¶µ" },
    { name:"Est√©tica", icon:"‚ú®" },
    { name:"Peluquer√≠a y Barber√≠a", icon:"üíà" },
    { name:"SPA & Wellness", icon:"üßñ" },
    { name:"Medicina", icon:"ü©∫" }
  ];

  const OFFERS_ITEMS = [
    { name:"Ofertas del momento" },
    { name:"M√°s vendidos" },
    { name:"Promociones" }
  ];

  // ====== Tracking / Experimento ======
  const VERSION = "FIN"; // Variante A/B/FIN...
  const SESSION_ID = (crypto?.randomUUID) ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2);

  const TASKS = [
    { id:"camilla_electrica", label:"Camilla el√©ctrica", route:["Camillas","Camillas el√©ctricas"],
      goal:"Encuentra la categor√≠a de camillas el√©ctricas en el men√∫.",
      info:"Camilla el√©ctrica: camilla cl√≠nica con motor para ajustar altura/secciones; se usa en fisioterapia, cl√≠nica y exploraci√≥n."
    },
    { id:"silla_ruedas_electrica", label:"Silla de ruedas el√©ctrica", route:["Sillas de ruedas","Sillas de ruedas el√©ctricas"],
      goal:"Encuentra la categor√≠a de sillas de ruedas el√©ctricas en el men√∫.",
      info:"Silla de ruedas el√©ctrica: motor y bater√≠a, control por joystick, pensada para movilidad reducida."
    },
    { id:"autoclave_clase_b", label:"Autoclave clase B", route:["Esterilizaci√≥n y autoclaves","Autoclaves","Autoclaves clase B"],
      goal:"Encuentra la categor√≠a de autoclaves clase B en el men√∫.",
      info:"Autoclave clase B: esterilizador de vapor con prevac√≠o/postvac√≠o, apto para instrumental hueco/poroso."
    }
  ];

  // ====== Estado ======
  let taskIndex = 0;
  let TASK = null;

  let START_TS = 0;
  let PAUSED = false;
  let PAUSE_TS = 0;
  let PAUSED_TOTAL_MS = 0;

  let NAV_PATH = [];
  let CLICK_COUNT = 0;
  let DETOURS = 0;

  let TIMER_INT = null; // se mantiene interno para Excel, pero no se pinta en UI
  let TASK_DONE = false;

  const EVENTS = [];
  const TASK_RESULTS = {};

  let TEST_STARTED = false;
  let TASK_ACTIVE = false;

  let menuTree = [];
  let bannersData = [];

  // ====== DOM ======
  const drawer = document.getElementById("drawer");
  const overlay = document.getElementById("overlay");
  const statusEl = document.getElementById("status");

  // ====== Helpers ======
  const norm2 = (s)=> String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
  const nowISO = ()=> new Date().toISOString();
  const norm = (s)=> String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
  const displayName = (name)=> String(name||"").replace(/\s+Total\s*$/i,"").trim();

  function effectiveElapsedMs(){
    if(!START_TS) return 0;
    const now = (PAUSED ? PAUSE_TS : Date.now());
    return Math.max(0, (now - START_TS) - PAUSED_TOTAL_MS);
  }

  // ====== LOG (para Excel) ======
  let EVENT_SEQ = 0;
  let LAST_EVENT_TS = 0;

  function track(eventName, extra = {}) {
    EVENT_SEQ += 1;
    const now = Date.now();
    const msFromPrev = LAST_EVENT_TS ? (now - LAST_EVENT_TS) : 0;
    LAST_EVENT_TS = now;

    const row = {
      ts_iso: nowISO(),
      version: VERSION,
      session_id: SESSION_ID,
      task_id: TASK?.id || "",
      task_label: TASK?.label || "",
      target_route: TASK?.route ? TASK.route.join(" > ") : "",

      seq: EVENT_SEQ,
      ms_from_prev: msFromPrev,

      event: eventName,

      label: extra.label || "",
      level: (typeof extra.level === "number") ? extra.level : "",
      expected_label: extra.expected_label || "",
      is_expected: (typeof extra.is_expected === "number") ? extra.is_expected : "",
      deviation: (typeof extra.deviation === "number") ? extra.deviation : "",
      deviation_reason: extra.deviation_reason || "",

      path_before: extra.path_before || "",
      path_after: extra.path_after || "",
      path: (typeof extra.path === "string") ? extra.path : (NAV_PATH.join(" > ")),

      ms_from_start: (START_TS && TASK_ACTIVE) ? effectiveElapsedMs() : "",
      detours: (typeof extra.detours === "number") ? extra.detours : DETOURS,

      task_status: extra.task_status || "",
      final_path: extra.final_path || ""
    };

    EVENTS.push(row);
  }

  // ====== Confetti ======
  function confettiBurstSlow(){
    const canvas = document.getElementById("confettiCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    canvas.style.display = "block";
    const N = 200, parts = [];
    for (let i=0;i<N;i++){
      parts.push({
        x:canvas.width/2+(Math.random()*140-70),
        y:canvas.height/2+(Math.random()*70-35),
        vx:(Math.random()*6-3),
        vy:(Math.random()*-9-4),
        g:0.16+Math.random()*0.12,
        s:4+Math.random()*5,
        r:Math.random()*Math.PI,
        vr:(Math.random()*0.12-0.06),
        life:150+Math.random()*70,
        hue:Math.floor(Math.random()*360)
      });
    }
    let t=0;
    (function frame(){
      t++; ctx.clearRect(0,0,canvas.width,canvas.height);
      parts.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.r+=p.vr; p.life--;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r);
        ctx.globalAlpha=Math.max(0,Math.min(1,p.life/190));
        ctx.fillStyle=`hsl(${p.hue},90%,55%)`;
        ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s*0.6);
        ctx.restore();
      });
      if (t<190) requestAnimationFrame(frame);
      else canvas.style.display="none";
    })();
  }

  function hardPause(){ if (TASK_ACTIVE && !PAUSED) { PAUSED = true; PAUSE_TS = Date.now(); } }

  function showCompletedBanner(message, title){
    hardPause();
    confettiBurstSlow();

    const seconds = START_TS ? (effectiveElapsedMs()/1000).toFixed(1) : "";
    const routeStr = NAV_PATH.join(" > ");

    document.getElementById("doneTitle").textContent = title;
    document.getElementById("doneDetail").textContent =
      `${message}\nRuta: ${routeStr}\nClicks: ${CLICK_COUNT}\nDesv√≠os: ${DETOURS}`;
    document.getElementById("doneTime").textContent = seconds ? `Tiempo: ${seconds}s` : "";
    document.getElementById("doneOverlay").style.display = "block";
  }

  // ====== Flow tareas ======
  function fillIntroTaskList(){
    const ul = document.getElementById("introTaskList");
    ul.innerHTML = "";
    TASKS.forEach((t, i) => {
      const li = document.createElement("li");
      li.textContent = `${i+1}. ${t.label} ‚Äî ${t.goal}`;
      ul.appendChild(li);
    });
  }

  function showNextTaskScreen(){
    TASK_ACTIVE = false;
    hardPause();
    TASK = TASKS[taskIndex];

    document.getElementById("nextTitle").textContent = `${taskIndex+1}/${TASKS.length} ¬∑ ${TASK.label}`;
    document.getElementById("nextGoal").innerHTML = `<b>Qu√© buscar:</b> ${TASK.goal}`;
    document.getElementById("nextInfo").innerHTML = `<b>Info:</b> ${TASK.info}`;
    document.querySelector("#nextRoute code").textContent = TASK.route.join(" > ");
    document.getElementById("nextTaskOverlay").style.display = "block";
  }
  function hideNextTaskScreen(){ document.getElementById("nextTaskOverlay").style.display = "none"; }

  function startThisTaskNow(){
    EVENT_SEQ = 0;
    LAST_EVENT_TS = 0;

    NAV_PATH = [];
    CLICK_COUNT = 0;
    DETOURS = 0;
    TASK_DONE = false;
    drawer.classList.remove("struggling");

    START_TS = Date.now();
    PAUSED = false;
    PAUSE_TS = 0;
    PAUSED_TOTAL_MS = 0;

    TASK_ACTIVE = true;
    track("task_start", { detours: DETOURS });

    if (TIMER_INT) clearInterval(TIMER_INT);
    TIMER_INT = setInterval(() => { /* no UI */ }, 250);

    hideNextTaskScreen();
    toggleMenu(true);
  }

  function pauseTask(){
    if (!TASK_ACTIVE || !START_TS || PAUSED) return;
    PAUSED = true;
    PAUSE_TS = Date.now();
    track("task_pause");
    document.getElementById("btnPause").style.display = "none";
    document.getElementById("btnResume").style.display = "block";
  }

  function resumeTask(){
    if (!TASK_ACTIVE || !START_TS || !PAUSED) return;
    PAUSED = false;
    PAUSED_TOTAL_MS += (Date.now() - PAUSE_TS);
    PAUSE_TS = 0;
    track("task_resume");
    document.getElementById("btnPause").style.display = "block";
    document.getElementById("btnResume").style.display = "none";
  }

  function isSuccessPath(){
    const current = NAV_PATH.map(norm2);
    const target  = TASK.route.map(norm2);
    if (current.length !== target.length) return false;
    for (let i=0;i<target.length;i++) if (current[i] !== target[i]) return false;
    return true;
  }

  function nextTaskFlow(){
    document.getElementById("doneOverlay").style.display = "none";

    if (TASK_ACTIVE) {
      track("task_end", {
        task_status: TASK_RESULTS[TASK?.id]?.status || (TASK_DONE ? "success" : ""),
        final_path: NAV_PATH.join(" > "),
        path: ""
      });
    }

    TASK_ACTIVE = false;
    if (TIMER_INT) { clearInterval(TIMER_INT); TIMER_INT = null; }

    taskIndex++;
    if (taskIndex >= TASKS.length) finishAllTasks();
    else showNextTaskScreen();
  }

  function finishAllTasks(){
    TASK_ACTIVE = false;
    if (TIMER_INT) { clearInterval(TIMER_INT); TIMER_INT = null; }
    track("tasks_finished", { path:"" });

    document.getElementById("finalOverlay").style.display = "block";
    setTimeout(() => {
      try { downloadExcelAuto(); }
      finally {
        document.getElementById("finalSubtitle").textContent = "‚úÖ Descarga iniciada. Ya puedes cerrar esta ventana.";
        document.getElementById("finalSpinner").style.display = "none";
      }
    }, 120);
  }

  function failTask(){
    if(!TASK_ACTIVE || TASK_DONE) return;
    TASK_DONE = true;
    const tms = effectiveElapsedMs();
    TASK_RESULTS[TASK.id] = { status:"fail", timeMs:tms, clicks: CLICK_COUNT, detours: DETOURS };
    track("task_fail", { task_status:"fail", path:"" });
    drawer.classList.remove("struggling");
    showCompletedBanner("‚ùå Marcada como 'No lo encuentro'", "‚ùå Tarea no encontrada");
  }

  // ====== Excel (XML Spreadsheet) ======
  function xmlEscape(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&apos;");
  }
  function worksheetXml(name, rows){
    const rowXml = rows.map(r => `<Row>${
      r.map(c => `<Cell${c.style?` ss:StyleID="${c.style}"`:``}><Data ss:Type="String">${xmlEscape(c.v)}</Data></Cell>`).join("")
    }</Row>`).join("");
    return `<Worksheet ss:Name="${xmlEscape(name)}"><Table>${rowXml}</Table></Worksheet>`;
  }
  function buildExcelXml(){
    const rowsSummary = [];
    const totalMs = Object.values(TASK_RESULTS).reduce((acc, r) => acc + (r.timeMs || 0), 0);

    rowsSummary.push([{v:"Sesi√≥n", style:"sHeader"},{v:SESSION_ID, style:"sCell"}]);
    rowsSummary.push([{v:"Variante (version)", style:"sHeader"},{v:VERSION, style:"sCell"}]);
    rowsSummary.push([{v:"Tiempo total (s)", style:"sHeader"},{v:(totalMs/1000).toFixed(1), style:"sCell"}]);
    rowsSummary.push([{v:"", style:"sCell"},{v:"", style:"sCell"}]);

    rowsSummary.push([
      {v:"Tarea", style:"sHeader"},
      {v:"Resultado", style:"sHeader"},
      {v:"Tiempo (s)", style:"sHeader"},
      {v:"Clicks", style:"sHeader"},
      {v:"Desv√≠os", style:"sHeader"},
      {v:"Ruta objetivo", style:"sHeader"}
    ]);

    TASKS.forEach(t => {
      const r = TASK_RESULTS[t.id];
      const status = r?.status || "fail";
      const det = (r?.detours ?? 0);
      const isSuccess = status !== "fail" && det === 0;
      const isWarn = status !== "fail" && det > 0;
      const styleRow = isSuccess ? "sSuccess" : (isWarn ? "sWarn" : "sFail");
      const labelRes = isSuccess ? "Encontrada" : (isWarn ? "Encontrada (con desv√≠os)" : "No encontrada");

      rowsSummary.push([
        {v:t.label, style:styleRow},
        {v:labelRes, style:styleRow},
        {v: r ? (r.timeMs/1000).toFixed(1) : "", style:styleRow},
        {v: r ? String(r.clicks ?? "") : "", style:styleRow},
        {v: r ? String(r.detours ?? "") : "", style:styleRow},
        {v: t.route.join(" > "), style:styleRow}
      ]);
    });

    const headers = EVENTS.length ? Object.keys(EVENTS[0]) : [
      "ts_iso","version","session_id","task_id","task_label","target_route",
      "seq","ms_from_prev","event","label","level","expected_label","is_expected",
      "deviation","deviation_reason","path_before","path_after","path","ms_from_start",
      "detours","task_status","final_path"
    ];

    const rowsEvents = [];
    rowsEvents.push(headers.map(h => ({v:h, style:"sHeader"})));
    EVENTS.forEach(e => rowsEvents.push(headers.map(h => ({v:e[h] ?? "", style:"sCell"}))));

    return `<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
 <Styles>
  <Style ss:ID="sHeader"><Font ss:Bold="1"/><Interior ss:Color="#E6F2FA" ss:Pattern="Solid"/></Style>
  <Style ss:ID="sCell"></Style>
  <Style ss:ID="sSuccess"><Interior ss:Color="#EAF7EE" ss:Pattern="Solid"/><Font ss:Bold="1" ss:Color="#0A7A3A"/></Style>
  <Style ss:ID="sWarn"><Interior ss:Color="#FFF7E6" ss:Pattern="Solid"/><Font ss:Bold="1" ss:Color="#8A4B00"/></Style>
  <Style ss:ID="sFail"><Interior ss:Color="#FDECEC" ss:Pattern="Solid"/><Font ss:Bold="1" ss:Color="#B42318"/></Style>
 </Styles>
 ${worksheetXml("Resumen", rowsSummary)}
 ${worksheetXml("Eventos", rowsEvents)}
</Workbook>`;
  }
  function downloadExcelAuto(){
    const xml = buildExcelXml();
    const blob = new Blob([xml], { type: "application/vnd.ms-excel;charset=utf-8" });
    const a = document.createElement("a");
    const ts = new Date().toISOString().replace(/[:.]/g,"-");
    a.href = URL.createObjectURL(blob);
    a.download = `test_usabilidad_menu_${VERSION}_${SESSION_ID}_${ts}.xls`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  // ====== CSV parsing / √°rbol ======
  function parseCSV(text){
    const rows = [];
    let cur = "", row = [], inQ = false;
    for (let i=0;i<text.length;i++){
      const ch = text[i];
      if (ch === '"') inQ = !inQ;
      else if (ch === ',' && !inQ){ row.push(cur); cur=""; }
      else if ((ch === '\n' || ch === '\r') && !inQ){
        row.push(cur); cur="";
        if (row.join("").trim()) rows.push(row);
        row=[];
      } else cur += ch;
    }
    row.push(cur); if(row.join("").trim()) rows.push(row);
    return rows;
  }
  function rowsToObjects(rows){
    if(!rows.length) return [];
    const header = rows[0].map(h => h.trim().toLowerCase());
    return rows.slice(1).map(row => {
      const obj = {};
      header.forEach((h, i) => obj[h] = (row[i] || "").trim());
      return obj;
    });
  }
  function sortNodes(nodes, level) {
    if (!nodes) return;
    if (level === 0) {
      const rank = new Map(TOP_ORDER.map((n, i) => [norm(n), i]));
      nodes.sort((a, b) => (rank.has(norm(a.name)) ? rank.get(norm(a.name)) : 999) - (rank.has(norm(b.name)) ? rank.get(norm(b.name)) : 999) || a.name.localeCompare(b.name));
    } else nodes.sort((a, b) => a.name.localeCompare(b.name));
    nodes.forEach(n => sortNodes(n.children, level + 1));
  }
  function buildTree(csv){
    const root = [];
    csv.split(/\r?\n/).forEach(line => {
      const clean = line.replace(/"/g, "").trim();
      if(!clean) return;
      const parts = clean.split(">").map(p => p.trim()).filter(Boolean);
      let current = root;
      parts.forEach((rawName) => {
        const name = displayName(rawName);
        let node = current.find(n => n.name === name);
        if(!node){ node = {name, children: []}; current.push(node); }
        current = node.children;
      });
    });
    sortNodes(root, 0);
    menuTree = root;
  }

  async function loadAllData(){
    statusEl.style.display="block";
    statusEl.textContent="Cargando...";
    try {
      const [catRes, banRes] = await Promise.all([fetch(DATA_URL), fetch(BANNERS_URL)]);
      const catCsv = await catRes.text();
      const banCsv = await banRes.text();

      buildTree(catCsv);
      bannersData = rowsToObjects(parseCSV(banCsv)).reverse();

      statusEl.style.display="none";
      renderRootMenu();
    } catch(e) {
      statusEl.textContent="Error de carga";
    }
  }

  // ====== Men√∫: root + especialidades/ofertas + banners ======
  function renderRootMenu(){
    const container = document.getElementById("columns-container");
    container.innerHTML = "";
    const col = document.createElement("div");
    col.className = "column";

    col.innerHTML = `<ul>
      <li class="item" onclick="renderSpecialties()">
        <span class="label"><span class="icon">‚≠ê</span><span class="text">Especialidades</span></span>${CHEVRON_SVG}
      </li>
      <li class="item" onclick="renderOffers()">
        <span class="label"><span class="icon">üè∑Ô∏è</span><span class="text">Ofertas</span></span>${CHEVRON_SVG}
      </li>
      <li class="item" onclick="renderAllCategories()">
        <span class="label"><span class="icon">üìÅ</span><span class="text">Todas las categor√≠as</span></span>${CHEVRON_SVG}
      </li>

      <li class="divider"></li>

      ${FEATURED_CATS.map(fc => `
        <li class="item">
          <span class="label">
            <span class="text">${fc.name}</span>
            ${fc.tag ? `<span class="tag ${fc.tag}">${fc.tag==='new'?'Nuevo':'Trending'}</span>` : ''}
          </span>
        </li>
      `).join('')}
    </ul>`;

    const b = bannersData.find(b => norm(b.scope) === "root");
    if (b) {
      col.innerHTML += `
        <div class="promo-card">
          <img class="promo-img" src="${b.img}">
          <a class="promo-link" href="${b.href || '#'}" target="_blank" rel="noopener"></a>
        </div>`;
    }

    container.appendChild(col);
  }

  window.renderSpecialties = function renderSpecialties(){
    const container = document.getElementById("columns-container");
    container.innerHTML = "";
    const col = document.createElement("div");
    col.className = "column";
    col.innerHTML = `
      <div class="column-header">
        <button class="back-only" onclick="renderRootMenu()">${BACK_CHEVRON_SVG}</button>
        Especialidades
      </div>
      <ul>
        ${SPECIALTIES_ITEMS.map(it => `
          <li class="item">
            <span class="label"><span class="icon">${it.icon}</span><span class="text">${it.name}</span></span>
          </li>
        `).join("")}
      </ul>`;
    container.appendChild(col);
  };

  window.renderOffers = function renderOffers(){
    const container = document.getElementById("columns-container");
    container.innerHTML = "";
    const col = document.createElement("div");
    col.className = "column";
    col.innerHTML = `
      <div class="column-header">
        <button class="back-only" onclick="renderRootMenu()">${BACK_CHEVRON_SVG}</button>
        Ofertas
      </div>
      <ul>
        ${OFFERS_ITEMS.map(it => `
          <li class="item"><span class="label"><span class="text">${it.name}</span></span></li>
        `).join("")}
      </ul>`;
    container.appendChild(col);
  };

  window.renderAllCategories = function(){ render(menuTree, 0); };

  // ====== Render categor√≠as + banners internos ======
  function render(items, level, parent=null){
    const container = document.getElementById("columns-container");
    if(level === 0) container.innerHTML = "";
    else Array.from(container.querySelectorAll(".column")).slice(level).forEach(c => c.remove());

    const col = document.createElement("div");
    col.className = "column";
    col.innerHTML = `<div class="column-header">${
      level===0
        ? `<button class="back-only" onclick="renderRootMenu()">${BACK_CHEVRON_SVG}</button> Todas las categor√≠as`
        : parent.name
    }</div><ul></ul>`;
    const ul = col.querySelector("ul");

    items.forEach(item => {
      const li = document.createElement("li");
      li.className = "item";
      const icon = level === 0 ? (ICON_MAP[norm(item.name)] || "") : "";
      li.innerHTML = `<span class="label">${icon?`<span class="icon">${icon}</span>`:""}<span class="text">${item.name}</span></span>${item.children.length?CHEVRON_SVG:''}`;

      li.onclick = () => {
        const wasActive = li.classList.contains("active");

        // ==== tracking click (mejorado) ====
        if (TEST_STARTED && TASK_ACTIVE && !TASK_DONE && !PAUSED) {
          const beforePathArr = [...NAV_PATH];

          NAV_PATH = NAV_PATH.slice(0, level);
          NAV_PATH[level] = item.name;

          const afterPathArr = [...NAV_PATH];

          CLICK_COUNT++;

          const expected = TASK.route[level] || "";
          const isExpected = expected ? (norm2(item.name) === norm2(expected)) : 0;

          let deviation = 0;
          let reason = "";

          if (!expected) {
            deviation = 1; reason = "extra_depth";
          } else if (!isExpected) {
            deviation = 1;
            reason = (level === 0) ? "wrong_top_category" : "wrong_choice_same_level";
          }

          if (deviation) {
            DETOURS++;
            drawer.classList.add("struggling");
          }

          track("click_item", {
            label: item.name,
            level,
            expected_label: expected,
            is_expected: isExpected ? 1 : 0,
            deviation,
            deviation_reason: reason,
            path_before: beforePathArr.join(" > "),
            path_after: afterPathArr.join(" > "),
            path: afterPathArr.join(" > ")
          });

          if (isSuccessPath()) {
            TASK_DONE = true;

            const tms = effectiveElapsedMs();
            const status = (DETOURS > 0) ? "success_with_detours" : "success";
            TASK_RESULTS[TASK.id] = { status, timeMs:tms, clicks:CLICK_COUNT, detours:DETOURS };

            track("task_success", {
              label: item.name,
              level,
              task_status: status,
              final_path: afterPathArr.join(" > "),
              path_before: beforePathArr.join(" > "),
              path_after: afterPathArr.join(" > "),
              path: afterPathArr.join(" > ")
            });

            if (status === "success_with_detours") li.classList.add("found-warn");
            drawer.classList.remove("struggling");

            showCompletedBanner(
              status === "success_with_detours" ? "‚úÖ Es la correcta (pero NO a la primera)" : "‚úÖ Es la correcta",
              status === "success_with_detours" ? "üü† Correcta con desv√≠os" : "üü¢ Tarea completada"
            );
          }
        }
        // ===============================

        Array.from(ul.children).forEach(l => l.classList.remove("active"));

        if(item.children.length && wasActive) {
          Array.from(container.querySelectorAll(".column")).slice(level+1).forEach(c => c.remove());
          li.classList.remove("active");
        } else {
          li.classList.add("active");
          if(item.children.length) render(item.children, level + 1, item);
        }
      };

      ul.appendChild(li);

      // Banner after_item
      if(parent){
        const bAfter = bannersData.find(b =>
          norm(b.scope) === "after_item" &&
          norm(b.parent) === norm(parent.name) &&
          norm(b.after) === norm(item.name)
        );
        if (bAfter) {
          const bLi = document.createElement("li");
          bLi.innerHTML = `
            <div class="promo-card small">
              <img class="promo-img" src="${bAfter.img}">
              <a class="promo-link" href="${bAfter.href||'#'}" target="_blank" rel="noopener"></a>
            </div>`;
          ul.appendChild(bLi);
        }
      }
    });

    // Banner category_children (al final de la columna)
    if(parent){
      const bChild = bannersData.find(b =>
        norm(b.scope) === "category_children" &&
        norm(b.parent) === norm(parent.name)
      );
      if (bChild) {
        col.insertAdjacentHTML("beforeend", `
          <div class="promo-card small">
            <img class="promo-img" src="${bChild.img}">
            <a class="promo-link" href="${bChild.href||'#'}" target="_blank" rel="noopener"></a>
          </div>`);
      }
    }

    container.appendChild(col);
  }

  function toggleMenu(open){
    drawer.style.display = open ? "flex" : "none";
    overlay.style.display = open ? "block" : "none";
    if(open && menuTree.length===0) loadAllData();
    else if(open) renderRootMenu();
  }

  // ====== Wiring ======
  document.getElementById("openBtn").onclick = () => toggleMenu(true);
  document.getElementById("closeBtn").onclick = () => toggleMenu(false);
  overlay.onclick = () => toggleMenu(false);

  document.getElementById("btnIntroStart").onclick = () => {
    TEST_STARTED = true;
    document.getElementById("taskIntroOverlay").style.display = "none";
    document.getElementById("abpanel").style.display = "block";
    taskIndex = 0;
    showNextTaskScreen();
  };

  document.getElementById("btnStartThisTask").onclick = () => startThisTaskNow();
  document.getElementById("btnNextTask").onclick = () => nextTaskFlow();
  document.getElementById("btnFailTask").onclick = () => failTask();
  document.getElementById("btnPause").onclick = () => pauseTask();
  document.getElementById("btnResume").onclick = () => resumeTask();

  // ====== Init ======
  fillIntroTaskList();
  document.getElementById("taskIntroOverlay").style.display = "block";
  loadAllData();
</script>
</body>
</html>

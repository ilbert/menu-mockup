<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menu Mockup - A/B Test (Fixed)</title>
  <style>
    :root{
      --brand:#034ca8; --brand2:#0b5bd3;
      --border:#e6e8eb; --bg:#f4f6f9;
      --warnBg:#fff7e6; --warnText:#8a4b00; --warnBorder:#ffb020;
      --shadow:0 24px 60px rgba(0,0,0,.18);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,sans-serif;background:var(--bg);overflow:hidden;color:#0f172a}
    header{background:#fff;height:60px;display:flex;align-items:center;padding:0 16px;border-bottom:1px solid var(--border)}
    .hamburger{width:44px;height:44px;border:1px solid var(--border);background:#fff;cursor:pointer;border-radius:12px;font-size:20px;color:var(--brand)}
    
    #overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1000}
    #drawer{position:fixed;inset:0 auto 0 0;background:#fff;z-index:1001;display:none;flex-direction:column;box-shadow:10px 0 30px rgba(0,0,0,.12);width:auto;max-width:96vw;transition:width 0.2s ease}
    .drawer-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-weight:900;color:var(--brand)}
    .close-x{border:none;background:none;cursor:pointer;font-size:18px}
    #status{padding:10px;text-align:center;font-size:12px;background:#fff3cd;display:none}

    #columns-container{display:flex;flex:1;overflow-x:auto;overflow-y:hidden;background:#fff;scrollbar-width:none}
    .column{flex:0 0 330px;border-right:1px solid #eee;overflow-y:auto;height:100%}
    @media(max-width:520px){.column{flex-basis:86vw}}

    ul{list-style:none;padding:0;margin:0}
    .item{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;gap:10px;cursor:pointer;font-size:14px;border-bottom:1px solid #f3f4f6}
    .item:hover{background:#f7f9fc;color:var(--brand)}
    .item.active{background:#e6f2fa;color:var(--brand);font-weight:900;border-left:5px solid var(--brand)}
    
    .label{display:flex;align-items:center;gap:10px;min-width:0}
    .text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .icon{width:22px;height:22px;display:inline-grid;place-items:center;font-size:18px;flex:0 0 auto}
    .chevron svg{width:18px;height:18px;stroke:var(--brand);stroke-width:2.6;fill:none;stroke-linecap:round;stroke-linejoin:round}
    
    .column-header{padding:14px 14px 8px;font-weight:900;color:var(--brand);font-size:18px;display:flex;align-items:center;gap:10px}
    .back-only{border:none;background:transparent;padding:0;cursor:pointer;display:inline-flex;align-items:center}
    .divider{border-top:1px solid #e5e7eb;margin:8px 0}
    
    .btn{padding:14px 18px;border-radius:16px;border:1px solid var(--border);font-weight:1000;cursor:pointer;font-size:14px}
    .btnPrimary{background:linear-gradient(180deg, var(--brand2), var(--brand));color:#fff;border-color:transparent}
    .btnWarn{background:linear-gradient(180deg, #ffcf6b, #ffb020);border-color:transparent;color:#3a2400}
    .btnDanger{background:linear-gradient(180deg, #ff6b6b, #e11d48);border-color:transparent;color:#fff}
    
    .chip{display:inline-flex;align-items:center;gap:8px;background:#eef4ff;border:1px solid #d7e4ff;color:#123e8f;padding:6px 12px;border-radius:999px;font-weight:1000;font-size:12px}
    .card{border:1px solid var(--border);border-radius:22px;background:#fff;box-shadow:var(--shadow)}
    
    #drawer.struggling .item.active, .item.found-warn{background:var(--warnBg)!important;color:var(--warnText)!important;border-left:5px solid var(--warnBorder)!important;font-weight:1000!important}

    .tag{font-size:11px;font-weight:1000;padding:2px 8px;border-radius:999px;margin-left:8px;white-space:nowrap}
    .tag.new{background:#e6f2fa;color:var(--brand)}
    .tag.trending{background:#eafaf1;color:#0a8f4e}

    .promo-card{margin:16px;border-radius:14px;overflow:hidden;position:relative;background:#f0f0f0;box-shadow:0 10px 25px rgba(0,0,0,.1)}
    .promo-img{width:100%;height:160px;object-fit:cover;display:block}
    .promo-link{position:absolute;inset:0;display:block}
    .promo-card.small{margin:12px 16px 8px}
    .promo-card.small .promo-img{height:120px}

    .modalOverlay{position:fixed;inset:0;background:rgba(0,40,90,.65);display:none;z-index:4000;padding:16px}
    .modalCard{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(980px, 92vw);padding:22px}
    .spinner{width:34px;height:34px;border-radius:50%;border:4px solid #dbe7ff;border-top-color:var(--brand);animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{to{transform:rotate(360deg)}}

    #abpanel{position:fixed;top:12px;right:12px;z-index:2000;padding:12px;width:340px;max-width:92vw;display:none;border-radius:18px;background:#fff;border:1px solid var(--border);box-shadow:0 14px 30px rgba(0,0,0,.16)}
    .panelTitle{font-weight:1000;color:#0b1b3a;font-size:13px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
    .panelTitle .dot{width:10px;height:10px;border-radius:999px;background:#16a34a}
    .panelBtns{display:grid;grid-template-columns:1fr;gap:10px}

    @media (max-width:720px){
      body{overflow:auto}
      .modalOverlay{padding:0}
      .modalCard{position:fixed;left:0;top:0;transform:none;width:100vw;height:100vh;border-radius:0;padding:16px;overflow:auto;border:none}
      #abpanel{top:auto;right:0;left:0;bottom:0;width:100vw;max-width:100vw;border-radius:18px 18px 0 0;padding:10px 12px 30px}
      #drawer,#columns-container{padding-bottom:132px}
    }
  </style>
</head>
<body>

<canvas id="confettiCanvas" style="position:fixed;inset:0;z-index:9999;pointer-events:none;display:none"></canvas>

<header>
  <button class="hamburger" id="openBtn">‚ò∞</button>
  <div style="margin-left:12px;font-weight:1000;color:var(--brand);">
    MENU <span style="font-weight:400;opacity:0.6;font-size:0.8em;">(VER: <span id="ver-display"></span>)</span>
  </div>
</header>

<div id="taskIntroOverlay" class="modalOverlay">
  <div class="card modalCard">
    <div style="font-weight:1000;font-size:24px;color:#0b1b3a;">Test de usabilidad A/B</div>
    <div style="margin-top:10px;color:#334155;">Vas a realizar 3 tareas. El tiempo empieza al pulsar "Comenzar tarea".</div>
    <div style="margin-top:20px;display:grid;gap:10px;">
      <div style="background:#f1f5f9;padding:14px;border-radius:12px;"><b>1.</b> Pulsa Empezar</div>
      <div style="background:#f1f5f9;padding:14px;border-radius:12px;"><b>2.</b> Lee la tarea</div>
      <div style="background:#f1f5f9;padding:14px;border-radius:12px;"><b>3.</b> Busca la categor√≠a en el men√∫</div>
    </div>
    <div style="margin-top:24px;text-align:center;">
      <button id="btnIntroStart" class="btn btnPrimary" style="width:100%;font-size:18px;">Empezar</button>
    </div>
  </div>
</div>

<div id="nextTaskOverlay" class="modalOverlay">
  <div class="card modalCard" style="text-align:center;width:min(500px,92vw);">
    <div class="chip">Siguiente tarea</div>
    <div id="nextTitle" style="margin:12px 0;font-weight:1000;font-size:20px;color:#0b1b3a;"></div>
    <div id="nextGoal" style="text-align:left;background:#f8fafc;padding:14px;border-radius:12px;border:1px solid #e2e8f0;color:#334155;"></div>
    <div style="margin-top:20px;">
      <button id="btnStartThisTask" class="btn btnPrimary" style="width:100%;font-size:18px;">Comenzar tarea</button>
    </div>
  </div>
</div>

<div id="finalOverlay" class="modalOverlay">
  <div class="card modalCard" style="text-align:center;width:min(500px,92vw);">
    <div style="font-size:30px;">‚úÖ</div>
    <div style="font-weight:1000;font-size:22px;margin-top:10px;">Test finalizado</div>
    <div style="margin-top:10px;">Descargando Excel...</div>
    <div class="spinner" id="finalSpinner" style="margin-top:20px;"></div>
  </div>
</div>

<div id="doneOverlay" style="position:fixed;inset:0;z-index:3000;display:none;background:rgba(0,0,0,.5);padding:16px;">
  <div class="card" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(400px,92vw);padding:20px;text-align:center;">
    <div id="doneTitle" style="font-weight:1000;font-size:20px;"></div>
    <div id="doneDetail" style="margin:10px 0;color:#475569;"></div>
    <button id="btnNextTask" class="btn btnPrimary" style="width:100%;">Siguiente</button>
  </div>
</div>

<div id="abpanel">
  <div class="panelTitle"><span class="dot"></span> En curso</div>
  <div class="panelBtns">
    <button id="btnPause" class="btn btnWarn">‚è∏ Pausa</button>
    <button id="btnResume" class="btn btnPrimary" style="display:none;">‚ñ∂ Reanudar</button>
    <button id="btnFailTask" class="btn btnDanger">No lo encuentro</button>
  </div>
</div>

<div id="overlay"></div>

<aside id="drawer">
  <div class="drawer-header">
    <span>MENU</span>
    <button class="close-x" id="closeBtn">‚úï</button>
  </div>
  <div id="status"></div>
  <div id="columns-container"></div>
</aside>

<script>
  // ==========================================
  // CONFIGURACI√ìN: CAMBIA 'A' o 'B'
  const TEST_VERSION = 'A';
  // ==========================================

  document.getElementById('ver-display').textContent = TEST_VERSION;

  // DATA
  const SHEET_ID = "1rG-kDB8Srrn-dIldsFuc7rwAc7q2EuNy4CHfz2kvDTY";
  const GID_CAT = "0";
  const GID_BAN = "1300813141";
  const DATA_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_CAT}`;
  const BANNERS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_BAN}`;

  const ICONS = {"aparatologia y equipos":"üìÅ","ayudas tecnicas para personas mayores":"üßì","camillas":"üõèÔ∏è","cuidado personal y salud":"üß¥","desechables y consumibles":"üßª","diagnostico":"ü©∫","esterilizacion y autoclaves":"üßº","instrumental":"üß∞","material medico":"üì¶","mobiliario":"ü™ë","sillas de ruedas":"ü¶Ω","vestuario y seguridad":"ü¶∫"};
  const CHEVRON = `<span class="chevron"><svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg></span>`;
  const BACK_CHEVRON = `<span class="chevron" style="transform:rotate(180deg)"><svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg></span>`;

  // STATE
  let menuTree = [], bannersData = [];
  let tasks = [
    {id:"t1", label:"Camilla el√©ctrica", route:["Camillas","Camillas el√©ctricas"], goal:"Busca: Camillas el√©ctricas"},
    {id:"t2", label:"Silla el√©ctrica", route:["Sillas de ruedas","Sillas de ruedas el√©ctricas"], goal:"Busca: Sillas de ruedas el√©ctricas"},
    {id:"t3", label:"Autoclave B", route:["Esterilizaci√≥n y autoclaves","Autoclaves","Autoclaves clase B"], goal:"Busca: Autoclave Clase B"}
  ];
  let taskIndex=0, currTask=null, sessionID = "sess_"+Date.now();
  let events=[], results={}, startTs=0, paused=false, pauseTs=0, pauseTotal=0;
  let navPath=[], clicks=0, detours=0, taskActive=false;

  // DOM
  const container = document.getElementById("columns-container");
  const drawer = document.getElementById("drawer");

  // UTILS
  const norm = s => String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
  const getElapsed = () => startTs ? Math.max(0, (paused?pauseTs:Date.now()) - startTs - pauseTotal) : 0;
  
  function track(evt, extra={}){
    events.push({
      ts: new Date().toISOString(), version: TEST_VERSION, event: evt,
      task: currTask?.id, path: navPath.join(">"), elapsed: getElapsed(), ...extra
    });
  }

  // --- CORE LOGIC ---
  
  function createItem(item, level) {
    const li = document.createElement("li");
    li.className = "item";
    
    // Icon Logic
    let icon = "";
    if(level === 0 && (TEST_VERSION === 'A' || TEST_VERSION === 'B')) {
       // En version A: root tiene iconos. En B: "Todas" (level 0 del submen√∫) tiene iconos.
       // Simplificaci√≥n: si el nombre coincide con el mapa, poner icono.
       icon = ICONS[norm(item.name)] || "";
    }
    
    li.innerHTML = `
      <span class="label">
        ${icon ? `<span class="icon">${icon}</span>` : ""}
        <span class="text">${item.name}</span>
      </span>
      ${item.children.length ? CHEVRON : ""}
    `;

    li.onclick = (e) => {
      e.stopPropagation();
      const wasActive = li.classList.contains("active");
      
      // UI: Remove active from siblings
      Array.from(li.parentNode.children).forEach(sibling => sibling.classList.remove("active"));
      
      // Logic: Close or Open
      if (wasActive) {
        // Closing: Remove columns to the right
        // We know the current column index is `level`. Remove anything > level.
        // Wait, current column index is determined by DOM.
        // Let's rely on explicit level. If I am at level 0, I open level 1.
        // If I close, I remove level 1+.
        clearColumnsFrom(level + 1);
      } else {
        // Opening
        li.classList.add("active");
        
        // Tracking logic
        if(taskActive) {
          navPath = navPath.slice(0, level);
          navPath.push(item.name);
          clicks++;
          
          const expected = currTask.route[level];
          if(norm(item.name) !== norm(expected)) {
            detours++;
            drawer.classList.add("struggling");
          }
          
          track("click", {label:item.name, level, detours});
          checkSuccess(item, level);
        }

        if(item.children.length) {
          renderColumn(item.children, level + 1, item);
        }
      }
      updateWidth();
    };
    return li;
  }

  function clearColumnsFrom(level) {
    const cols = container.querySelectorAll(".column");
    for(let i=level; i<cols.length; i++) cols[i].remove();
  }

  function renderColumn(items, level, parentItem=null) {
    clearColumnsFrom(level);
    
    const col = document.createElement("div");
    col.className = "column";
    
    // Header
    let headerText = parentItem ? parentItem.name : "Todas las categor√≠as";
    if(level === 0 && TEST_VERSION === 'A') headerText = ""; // Root A no header needed inside items
    
    let headerHtml = `<div class="column-header">`;
    if(level > 0 || (TEST_VERSION==='B' && level===0)) {
       headerHtml += `<button class="back-only" onclick="resetToRoot()">‚¨Ö</button> `;
    }
    headerHtml += `<span class="text">${headerText}</span></div>`;

    if(level===0 && TEST_VERSION==='A') headerHtml = ""; // No header for Root A, built outside

    col.innerHTML = headerHtml;
    
    const ul = document.createElement("ul");
    items.forEach(item => {
      ul.appendChild(createItem(item, level));
      
      // Banners logic simplified
      if(parentItem) {
        const ban = bannersData.find(b => norm(b.scope)==='after_item' && norm(b.after)===norm(item.name));
        if(ban) ul.innerHTML += `<div class="promo-card small"><img class="promo-img" src="${ban.img}"></div>`;
      }
    });
    
    col.appendChild(ul);
    container.appendChild(col);
    updateWidth();
  }

  function renderRoot() {
    container.innerHTML = "";
    
    if(TEST_VERSION === 'A') {
      // VERSION A: Special items + Direct Category List
      const col = document.createElement("div");
      col.className = "column";
      
      const ul = document.createElement("ul");
      ul.innerHTML = `
        <li class="item" onclick="showSpec()"><span class="label">‚≠ê Especialidades</span>${CHEVRON}</li>
        <li class="item" onclick="showOffer()"><span class="label">üè∑Ô∏è Ofertas</span>${CHEVRON}</li>
        <li class="divider"></li>
      `;
      
      // Append Categories directly
      menuTree.forEach(item => {
        ul.appendChild(createItem(item, 0));
      });
      
      col.appendChild(ul);
      // Root Banner
      const b = bannersData.find(b=>norm(b.scope)==='root');
      if(b) col.innerHTML += `<div class="promo-card"><img class="promo-img" src="${b.img}"></div>`;
      
      container.appendChild(col);

    } else {
      // VERSION B: Special + Button "Todas"
      const col = document.createElement("div");
      col.className = "column";
      col.innerHTML = `
        <ul>
          <li class="item" onclick="showSpec()"><span class="label">‚≠ê Especialidades</span>${CHEVRON}</li>
          <li class="item" onclick="showOffer()"><span class="label">üè∑Ô∏è Ofertas</span>${CHEVRON}</li>
          <li class="divider"></li>
          <li class="item" onclick="renderColumn(menuTree, 0)"><span class="label">üìÅ Todas las categor√≠as</span>${CHEVRON}</li>
          <li class="divider"></li>
          <li class="item"><span class="label">üî• Trending</span></li>
        </ul>
      `;
      const b = bannersData.find(b=>norm(b.scope)==='root');
      if(b) col.innerHTML += `<div class="promo-card"><img class="promo-img" src="${b.img}"></div>`;
      container.appendChild(col);
    }
    updateWidth();
  }

  function checkSuccess(item, level) {
    const route = currTask.route;
    // Check path match
    let correct = true;
    for(let i=0; i<=level; i++) {
      if(norm(navPath[i]) !== norm(route[i])) correct = false;
    }
    
    // If full path matched
    if(correct && level === route.length - 1) {
      taskActive = false;
      const status = detours === 0 ? "success" : "warn";
      track("success", {status});
      drawer.classList.remove("struggling");
      
      document.getElementById("doneTitle").textContent = "¬°Encontrado!";
      document.getElementById("doneDetail").textContent = status==='warn' ? "Con algunos desv√≠os." : "A la primera.";
      document.getElementById("doneOverlay").style.display = "block";
      
      // Mark visual success
      // Find the last clicked item and color it
      const cols = container.querySelectorAll(".column");
      const lastCol = cols[cols.length-1];
      const activeItem = lastCol.querySelector(".item.active");
      if(activeItem) activeItem.classList.add("found-warn");
      
      confettiBurst();
    }
  }

  // --- HELPERS UI ---
  window.resetToRoot = () => renderRoot();
  window.showSpec = () => {
    clearColumnsFrom(0); // Clear all
    const col = document.createElement("div");
    col.className="column";
    col.innerHTML=`<div class="column-header"><button class="back-only" onclick="resetToRoot()">‚¨Ö</button> Especialidades</div><ul><li class="item">Fisioterapia</li><li class="item">Est√©tica</li></ul>`;
    container.appendChild(col);
    updateWidth();
  }
  window.showOffer = () => {
    clearColumnsFrom(0);
    const col = document.createElement("div");
    col.className="column";
    col.innerHTML=`<div class="column-header"><button class="back-only" onclick="resetToRoot()">‚¨Ö</button> Ofertas</div><ul><li class="item">Promociones</li></ul>`;
    container.appendChild(col);
    updateWidth();
  }
  function updateWidth(){ drawer.style.width = Math.min(container.children.length * 330, window.innerWidth*.95) + "px"; }

  // --- INIT DATA ---
  async function loadData() {
    try {
      const t = await (await fetch(DATA_URL)).text();
      const rows = [];
      t.split('\n').forEach(l=>{
        const p = l.replace(/"/g,'').trim().split('>').map(s=>s.trim()).filter(Boolean);
        if(p.length) {
          let curr = menuTree;
          p.forEach(name=>{
             let n = curr.find(x=>x.name===name);
             if(!n){n={name,children:[]}; curr.push(n);}
             curr = n.children;
          });
        }
      });
      // Sort
      const ord = ["Camillas","Mobiliario","Sillas de ruedas"];
      const r = new Map(ord.map((x,i)=>[norm(x),i]));
      menuTree.sort((a,b)=> (r.has(norm(a.name))?r.get(norm(a.name)):99)-(r.has(norm(b.name))?r.get(norm(b.name)):99));

      const bT = await (await fetch(BANNERS_URL)).text();
      // Simple CSV parser for banners
      bT.split('\n').slice(1).forEach(l=>{
         const c = l.split(',');
         if(c.length>3) bannersData.push({scope:c[0],parent:c[1],after:c[2],img:c[3]});
      });
      
      renderRoot();
    } catch(e){ document.getElementById("status").textContent="Error loading data"; document.getElementById("status").style.display="block"; }
  }

  // --- FLOW ---
  document.getElementById("openBtn").onclick=()=>{drawer.style.display="flex"; document.getElementById("overlay").style.display="block"; if(!menuTree.length)loadData();};
  document.getElementById("closeBtn").onclick=()=>{drawer.style.display="none"; document.getElementById("overlay").style.display="none";};
  document.getElementById("overlay").onclick=document.getElementById("closeBtn").onclick;

  document.getElementById("btnIntroStart").onclick=()=>{
    document.getElementById("taskIntroOverlay").style.display="none";
    document.getElementById("abpanel").style.display="block";
    showTask();
  };
  
  function showTask(){
    currTask = tasks[taskIndex];
    document.getElementById("nextTitle").textContent = `Tarea ${taskIndex+1}/${tasks.length}`;
    document.getElementById("nextGoal").textContent = currTask.goal;
    document.getElementById("nextTaskOverlay").style.display="block";
  }

  document.getElementById("btnStartThisTask").onclick=()=>{
    document.getElementById("nextTaskOverlay").style.display="none";
    taskActive=true; startTs=Date.now(); navPath=[]; clicks=0; detours=0;
    drawer.style.display="flex"; document.getElementById("overlay").style.display="block";
    renderRoot();
  };
  
  document.getElementById("btnNextTask").onclick=()=>{
    document.getElementById("doneOverlay").style.display="none";
    taskIndex++;
    if(taskIndex<tasks.length) showTask();
    else finish();
  };
  
  document.getElementById("btnFailTask").onclick=()=>{
    if(!taskActive) return;
    track("fail");
    taskActive=false;
    document.getElementById("doneTitle").textContent = "Tarea omitida";
    document.getElementById("doneDetail").textContent = "";
    document.getElementById("doneOverlay").style.display="block";
  };
  
  function finish(){
    document.getElementById("finalOverlay").style.display="block";
    // Generate Excel
    const header = Object.keys(events[0]||{}).join("\t");
    const rows = events.map(e=>Object.values(e).join("\t")).join("\n");
    const blob = new Blob([header+"\n"+rows], {type:"application/vnd.ms-excel"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `test_${TEST_VERSION}_${Date.now()}.xls`;
    document.body.appendChild(a);
    a.click();
  }
  
  function confettiBurst(){
     const c = document.getElementById("confettiCanvas"); c.style.display="block";
     const ctx = c.getContext("2d"); c.width=window.innerWidth; c.height=window.innerHeight;
     let p=[]; for(let i=0;i<100;i++) p.push({x:c.width/2,y:c.height/2,vx:(Math.random()-.5)*10,vy:(Math.random()-1)*10,c:`hsl(${Math.random()*360},100%,50%)`});
     function step(){
       ctx.clearRect(0,0,c.width,c.height);
       p.forEach(x=>{x.x+=x.vx;x.y+=x.vy;x.vy+=.5;ctx.fillStyle=x.c;ctx.fillRect(x.x,x.y,5,5)});
       if(p[0].y<c.height) requestAnimationFrame(step); else c.style.display="none";
     }
     step();
  }

  // START
  loadData();

</script>
</body>
</html>

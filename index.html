<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menu Mockups</title>
  <style>
    :root{
      --brand:#034ca8;
      --border:#e6e8eb;
      --bg:#f4f6f9;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);overflow:hidden}
    header{background:#fff;height:60px;display:flex;align-items:center;padding:0 20px;border-bottom:1px solid var(--border)}
    .hamburger{width:42px;height:42px;border:1px solid var(--border);background:#fff;cursor:pointer;border-radius:8px;font-size:20px;color:var(--brand)}
    #overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1000}
    #drawer{position:fixed;inset:0 auto 0 0;background:#fff;z-index:1001;display:none;flex-direction:column;box-shadow:10px 0 30px rgba(0,0,0,.12);width:auto;max-width:96vw}
    .drawer-header{padding:15px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-weight:900;color:var(--brand)}
    .close-x{border:none;background:none;cursor:pointer;font-size:18px;line-height:1}
    #status{padding:10px;text-align:center;font-size:12px;background:#fff3cd}
    #columns-container{display:flex;flex:1;overflow-x:auto;overflow-y:hidden;background:#fff;scrollbar-width:none;-ms-overflow-style:none}
    #columns-container::-webkit-scrollbar{height:0px}

    .column{flex:0 0 330px;border-right:1px solid #eee;overflow-y:auto;height:100%}
    @media (max-width:520px){.column{flex-basis:86vw}}

    ul{list-style:none;padding:0;margin:0}
    .item{padding:14px 20px;display:flex;justify-content:space-between;align-items:center;gap:10px;cursor:pointer;font-size:13px;border-bottom:1px solid #f3f4f6}
    .item:hover{background:#f7f9fc;color:var(--brand)}
    .item.active{background:#e6f2fa;color:var(--brand);font-weight:800;border-left:5px solid var(--brand)}

    .label{display:flex;align-items:center;gap:10px;min-width:0}
    .text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .icon{width:22px;height:22px;display:inline-grid;place-items:center;font-size:18px;flex:0 0 auto}

    .chevron{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;flex:0 0 auto}
    .chevron svg{width:18px;height:18px;stroke:var(--brand);stroke-width:2.6;fill:none;stroke-linecap:round;stroke-linejoin:round}

    .column-header{padding:14px 16px 8px;font-weight:900;color:var(--brand);font-size:18px;display:flex;align-items:center;gap:10px}
    .view-all{display:block;padding:0 16px 12px;color:var(--brand);text-decoration:underline;font-weight:650;font-size:14px}

    .back-only{border:none;background:transparent;padding:0;cursor:pointer;display:inline-flex;align-items:center}

    .divider{border-top:1px solid #e5e7eb;margin:8px 0;}
    .tag{font-size:12px;font-weight:800;padding:2px 8px;border-radius:999px;margin-left:8px;white-space:nowrap}
    .tag.new{background:#e6f2fa;color:var(--brand)}
    .tag.trending{background:#eafaf1;color:#0a8f4e}
  
    /* Banners din√°micos */
    .promo-card{margin:16px;border-radius:14px;overflow:hidden;position:relative;background:#fff;box-shadow:0 10px 25px rgba(0,0,0,.10);}
    .promo-img{width:100%;height:160px;object-fit:cover;display:block;}
    .promo-link{position:absolute;inset:0;display:block;}
    .promo-card.small{margin:12px 16px 8px;}
    .promo-card.small .promo-img{height:120px;}
    
  </style>
</head>
<body>
<header>
  <button class="hamburger" id="openBtn">‚ò∞</button>
  <div style="margin-left:15px;font-weight:900;color:var(--brand);">MENU MOCKUP</div>
</header>

<div id="overlay"></div>

<aside id="drawer">
  <div class="drawer-header">
    <span></span>
    <button class="close-x" id="closeBtn" aria-label="Cerrar">‚úï</button>
  </div>
  <div id="status">Cargando categor√≠as desde Google Sheets...</div>
  <div id="columns-container"></div>
</aside>

<script>


  // ‚úÖ Tu CSV publicado
  const DATA_URL_BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTB17XxLBUzcUlZZeEh-UPryJijWIBOlec4xgD3BZ9JnF_zy3zKPdlMZpfLpr8bEygm2z5fLhp-ZxFk/pub?gid=0&single=true&output=csv";
  const DATA_URL = DATA_URL_BASE + "&_=" + Date.now();

  // Pesta√±a banners (gid)
  const BANNERS_GID = "1300813141";
  const BANNERS_URL = DATA_URL_BASE.replace("gid=0&single=true&output=csv", `gid=1300813141&single=true&output=csv`);
  let bannersConfig = [];


  // Banners din√°micos (pesta√±a "banners")
  

  const CHEVRON_SVG = `<span class="chevron" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg></span>`;
  const BACK_CHEVRON_SVG = `<span class="chevron" aria-hidden="true" style="transform:rotate(180deg)"><svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg></span>`;

  // üü¶ Orden manual del NIVEL 1 (SIN "Total")
  const TOP_ORDER = [
    "Camillas",
    "Mobiliario",
    "Sillas de ruedas",
    "Aparatolog√≠a  y equipos",
    "Esterilizaci√≥n y autoclaves",
    "Material m√©dico",
    "Cuidado personal y salud",
    "Desechables y consumibles",
    "Ayudas t√©cnicas para personas mayores",
    "Vestuario y seguridad"
  ];

  // Iconos del primer nivel (SIN "Total")
  const ICON_MAP = {
    "aparatologia y equipos":"üìÅ",
    "ayudas tecnicas para personas mayores":"üßì",
    "camillas":"üõèÔ∏è",
    "cuidado personal y salud":"üß¥",
    "desechables y consumibles":"üßª",
    "diagnostico":"ü©∫",
    "electrodomesticos y hogar":"üè†",
    "esterilizacion y autoclaves":"üßº",
    "instrumental":"üß∞",
    "material medico":"üì¶",
    "mobiliario":"ü™ë",
    "ofertas y campanas":"üè∑Ô∏è",
    "sillas de ruedas":"ü¶Ω",
    "vestuario y seguridad":"ü¶∫"
  };

  // Iconos para items del men√∫ ra√≠z (debajo de Ofertas, etc.)
  const ROOT_ICON_MAP = {
    "especialidades": "‚≠ê"
  };

  const OFFERS_ITEMS = [
    { name:"Ofertas del momento", children:[] },
    { name:"M√°s vendidos", children:[] },
    { name:"Promociones", children:[] }
  ];

  // 4 destacadas debajo de ‚ÄúOfertas‚Äù (root)
  const FEATURED_CATS = [
    { name:"Camillas", tag:"trending" },
    { name:"Sillas de ruedas", tag:"new" },
    { name:"Diagn√≥stico", tag:null },
    { name:"Mobiliario", tag:null }
  ];

  // Especialidades (debajo de Ofertas)
  const SPECIALTIES_ITEMS = [
    { name:"Fisioterapia", icon:"ü¶µ", children:[] },
    { name:"Est√©tica", icon:"‚ú®", children:[] },
    { name:"Peluquer√≠a y Barber√≠a", icon:"üíà", children:[] },
    { name:"SPA & Wellness", icon:"üßñ", children:[] },
    { name:"Medicina", icon:"ü©∫", children:[] }
  ];

  const norm = (s) => String(s||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .toLowerCase().trim().replace(/\s+/g," ");

  // ‚úÖ Quita " Total" al final (si existe)
  function displayName(name){
    return String(name||"").replace(/\s+Total\s*$/i,"").trim();
  }

  const getIconForFirstLevel = (name) => ICON_MAP[norm(displayName(name))] || "";

  function slugifyPath(s){
    return String(s||"")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toLowerCase().trim()
      .replace(/\s+/g,"-")
      .replace(/[^a-z0-9\-\/ >]+/g,"")
      .replace(/\s*>\s*/g,"/")
      .replace(/\/+/g,"/")
      .replace(/^-+|-+$/g,"");
  }

  // Ordena hijos alfab√©tico (nivel 2+)
  function sortChildrenAlpha(nodes){
    nodes.forEach(n => {
      n.children.sort((a,b)=>displayName(a.name).localeCompare(displayName(b.name)));
      sortChildrenAlpha(n.children);
    });
  }

  // Orden manual del nivel 1
  function sortTopLevel(nodes){
    const rank = new Map(TOP_ORDER.map((n,i)=>[norm(n), i]));
    nodes.sort((a,b)=>{
      const ra = rank.has(norm(displayName(a.name))) ? rank.get(norm(displayName(a.name))) : 9999;
      const rb = rank.has(norm(displayName(b.name))) ? rank.get(norm(displayName(b.name))) : 9999;
      if(ra !== rb) return ra - rb;
      return displayName(a.name).localeCompare(displayName(b.name));
    });
  }

  let menuTree = [];

  const drawer = document.getElementById("drawer");
  const overlay = document.getElementById("overlay");
  document.getElementById("openBtn").onclick = () => toggleMenu(true);
  document.getElementById("closeBtn").onclick = () => toggleMenu(false);
  overlay.onclick = () => toggleMenu(false);


  function updateDrawerWidth(){
    const cols = document.querySelectorAll('#columns-container .column').length || 1;
    const colWidth = 330; // igual que .column
    const desired = cols * colWidth + 1; // +1 para borde
    const maxW = Math.floor(window.innerWidth * 0.96);
    drawer.style.width = Math.min(desired, maxW) + "px";
  }

  window.addEventListener('resize', () => {
    if (drawer.style.display === 'flex') updateDrawerWidth();
  }, { passive: true });


  function toggleMenu(open){
    if(open){
      drawer.style.display="flex";
      drawer.style.width = "330px";
      overlay.style.display="block";
      if(menuTree.length===0) loadData();
      else renderRootMenu();
    } else {
      drawer.style.display="none";
      overlay.style.display="none";
      drawer.style.width = "";
    }
  }

  function parseCsv(text){
  const rows=[]; let row=[]; let cur=""; let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i], next=text[i+1];
    if(ch === '"'){
      if(inQuotes && next === '"'){ cur+='"'; i++; }
      else inQuotes = !inQuotes;
    } else if(ch === ',' && !inQuotes){
      row.push(cur); cur="";
    } else if((ch==='\n' || ch==='\r') && !inQuotes){
      if(ch==='\r' && next==='\n') i++;
      row.push(cur);
      if(row.some(c=>c.trim()!=="")) rows.push(row);
      row=[]; cur="";
    } else cur+=ch;
  }
  if(cur.length || row.length){
    row.push(cur);
    if(row.some(c=>c.trim()!=="")) rows.push(row);
  }
  return rows.map(r=>r.map(c=>c.trim()));
}

function rowsToObjects(rows){
  if(!rows.length) return [];
  const header = rows[0].map(h => norm(h));
  const objs=[];
  for(let i=1;i<rows.length;i++){
    const o={};
    rows[i].forEach((v,idx)=>{ o[header[idx]||("col"+idx)] = (v||"").replace(/^"|"$/g,"").trim(); });
    if(Object.values(o).every(v=>!v)) continue;
    objs.push(o);
  }
  return objs;
}

async function fetchWithTimeout(url, ms){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  try{
    const res = await fetch(url, {signal: ctrl.signal});
    return res;
  } finally {
    clearTimeout(t);
  }
}

async function loadBanners(){
    try{
      const url = BANNERS_URL + "&_=" + Date.now();
      const res = await fetch(url);
      if(!res.ok) throw new Error("No OK");
      const txt = await res.text();
      if(txt.trim().startsWith("<")) throw new Error("HTML");
      const rows = parseCsv(txt);
      const objs = rowsToObjects(rows);
      if(objs.length){
        bannersConfig = objs;
        return;
      }
    }catch(e){
      // No rompe el men√∫ si banners falla
    }
    bannersConfig = [];
  }

function findBanner({scope,parent,after}){
  const sc = scope ? norm(scope) : "";
  const p = parent ? norm(displayName(parent)) : "";
  const a = after ? norm(displayName(after)) : "";
  // Si hay duplicados, gana la √∫ltima fila
  for(let i=bannersConfig.length-1; i>=0; i--){
    const b = bannersConfig[i];
    if(norm(b.scope) !== sc) continue;
    if(p && norm(displayName(b.parent)) !== p) continue;
    if(a && norm(displayName(b.after)) !== a) continue;
    return b;
  }
  return null;
}

function renderBannerCard(b, extraClass){
  if(!b) return null;
  const img0 = b.img || b.image || "";
  if(!img0) return null;
  const img = img0 + (img0.includes('?') ? '&' : '?') + '_=' + Date.now();
  const href = b.href || b.link || "#";
  const alt = b.title || b.alt || "Promo";
  const card = document.createElement("div");
  card.className = "promo-card" + (extraClass ? (" " + extraClass) : "");
  card.innerHTML = `<img class="promo-img" src="${img}" alt="${alt}"><a class="promo-link" href="${href}" aria-label="${alt}"></a>`;
  return card;
}

async function loadData(){
    const status = document.getElementById("status");
    if (location.protocol === "file:") {
      status.style.display="block";
      status.textContent="‚ö†Ô∏è Abre este archivo desde un servidor (GitHub Pages / localhost). No funciona con file://";
      return;
    }
    try {
      const res = await fetch(DATA_URL);
      if(!res.ok) throw new Error("No se pudo leer el CSV");
      const csv = await res.text();
      if(csv.trim().startsWith("<")) throw new Error("Sheets devolvi√≥ HTML (permisos/publicaci√≥n)");
      buildTree(csv);
      await loadBanners();
      status.style.display="none";
      renderRootMenu();
    } catch(e) {
      status.style.display="block";
      status.textContent="‚ö†Ô∏è Error cargando datos. Revisa consola.";
      console.error(e);
    }
  }

  function buildTree(csv){
    const root = [];

    // 1) Normaliza y deduplica rutas (Set)
    const seen = new Set();

    const lines = csv.split(/\r?\n/);
    for (const line of lines) {
      const clean = line.replace(/"/g, "").trim();
      if (!clean) continue;

      // Normaliza separadores y espacios
      const parts = clean
        .split(">")
        .map(p => p.trim().replace(/\s+/g, " "))
        .filter(Boolean);

      if (parts.length < 1) continue;

      // Clave canonical para dedupe (sin acentos + min√∫sculas + sin "Total")
      const key = parts.map(p => norm(displayName(p))).join(">");

      if (seen.has(key)) continue;
      seen.add(key);

      // 2) Construye el √°rbol usando textos "bonitos" (sin Total)
      let current = root;
      parts.forEach((rawName, i) => {
        const name = displayName(rawName);
        let node = current.find(n => n.name === name);
        if (!node) {
          node = {
            name,
            children: [],
            path: parts.slice(0, i+1).map(displayName).join(" > ")
          };
          current.push(node);
        } else if (!node.path) {
          node.path = parts.slice(0, i+1).map(displayName).join(" > ");
        }
        current = node.children;
      });
    }

    menuTree = root;

    // ‚úÖ Ordena nivel 1 como quieres (sin Total), y el resto alfab√©tico
    sortTopLevel(menuTree);
    sortChildrenAlpha(menuTree);
  }

  function renderRootMenu(){
    const container = document.getElementById("columns-container");
    container.innerHTML="";
    const col = document.createElement("div");
    col.className="column";
    const ul = document.createElement("ul");

    const rootItems = [
      { name:"Especialidades", type:"specialties" },
      { name:"Ofertas", type:"offers" },
      { name:"Todas las categor√≠as", type:"all" }
    ];

    rootItems.forEach(item => {
      const li = document.createElement("li");
      li.className="item";
      const rootIcon = (item.type==="specialties") ? (ROOT_ICON_MAP["especialidades"] || "") : "";
      li.innerHTML = `<span class="label">${rootIcon ? `<span class="icon">${rootIcon}</span>` : ""}<span class="text">${item.name}</span></span>${CHEVRON_SVG}`;
      li.onclick = () => {
        Array.from(ul.children).forEach(el=>el.classList.remove("active"));
        li.classList.add("active");
        if(item.type==="specialties") renderSpecialties();
        else if(item.type==="offers") renderOffers();
        else renderAllCategories();
    updateDrawerWidth();
  };
      ul.appendChild(li);

      if(parentItem){
        const bAfter = findBanner({scope:"after_item", parent: parentItem.name, after: item.name});
        const afterCard = renderBannerCard(bAfter, "small");
        if(afterCard){
          const liB = document.createElement('li');
          liB.style.borderBottom='none';
          liB.appendChild(afterCard);
          ul.appendChild(liB);
        }
      }

    });

    
    // l√≠nea + destacadas (se muestran debajo de "Todas las categor√≠as", pero asociadas a Ofertas)
    const div = document.createElement("li");
    div.className = "divider";
    ul.appendChild(div);

    FEATURED_CATS.forEach(fc => {
      const fli = document.createElement("li");
      fli.className = "item";
      fli.innerHTML =
        `<span class="label"><span class="text">${fc.name}</span>` +
        `${fc.tag ? `<span class="tag ${fc.tag}">${fc.tag==="new"?"Nuevo":"Trending"}</span>` : ""}` +
        `</span>`;
      ul.appendChild(fli);
    });

    col.appendChild(ul);

    const bRoot = findBanner({scope:"root"});
    const rootCard = renderBannerCard(bRoot, "");
    if(rootCard) col.appendChild(rootCard);

    container.appendChild(col);
  }

  function renderOffers(){
    const container = document.getElementById("columns-container");
    container.innerHTML="";
    const col = document.createElement("div");
    col.className="column";

    const bar = document.createElement("div");
    bar.className="column-header";
    const back = document.createElement("button");
    back.className="back-only";
    back.innerHTML = BACK_CHEVRON_SVG;
    back.onclick = () => renderRootMenu();
    const title = document.createElement("div");
    title.textContent="Ofertas";
    bar.appendChild(back);
    bar.appendChild(title);
    col.appendChild(bar);

    const ul = document.createElement("ul");
    OFFERS_ITEMS.forEach(it=>{
      const li=document.createElement("li");
      li.className="item";
      li.innerHTML = `<span class="label">${it.icon ? `<span class="icon">${it.icon}</span>` : ``}<span class="text">${it.name}</span></span>`;
      ul.appendChild(li);

      if(parentItem){
        const bAfter = findBanner({scope:"after_item", parent: parentItem.name, after: item.name});
        const afterCard = renderBannerCard(bAfter, "small");
        if(afterCard){
          const liB = document.createElement('li');
          liB.style.borderBottom='none';
          liB.appendChild(afterCard);
          ul.appendChild(liB);
        }
      }

    updateDrawerWidth();
  });
    col.appendChild(ul);

    const bRoot = findBanner({scope:"root"});
    const rootCard = renderBannerCard(bRoot, "");
    if(rootCard) col.appendChild(rootCard);

    container.appendChild(col);
  }


  function renderSpecialties(){
    const container = document.getElementById("columns-container");
    container.innerHTML="";
    const col = document.createElement("div");
    col.className="column";

    const bar = document.createElement("div");
    bar.className="column-header";
    const back = document.createElement("button");
    back.className="back-only";
    back.innerHTML = BACK_CHEVRON_SVG;
    back.onclick = () => renderRootMenu();
    const title = document.createElement("div");
    title.textContent="Especialidades";
    bar.appendChild(back);
    bar.appendChild(title);
    col.appendChild(bar);

    const ul = document.createElement("ul");
    SPECIALTIES_ITEMS.forEach(it=>{
      const li=document.createElement("li");
      li.className="item";
      li.innerHTML = `<span class="label">${it.icon ? `<span class="icon">${it.icon}</span>` : ``}<span class="text">${it.name}</span></span>`;
      ul.appendChild(li);

      if(parentItem){
        const bAfter = findBanner({scope:"after_item", parent: parentItem.name, after: item.name});
        const afterCard = renderBannerCard(bAfter, "small");
        if(afterCard){
          const liB = document.createElement('li');
          liB.style.borderBottom='none';
          liB.appendChild(afterCard);
          ul.appendChild(liB);
        }
      }

    updateDrawerWidth();
  });
    col.appendChild(ul);

    const bRoot = findBanner({scope:"root"});
    const rootCard = renderBannerCard(bRoot, "");
    if(rootCard) col.appendChild(rootCard);

    container.appendChild(col);
    updateDrawerWidth();
  }

  function renderAllCategories(){
    render(menuTree, 0, null);
  }

  function render(items, level, parentItem=null){
    const container = document.getElementById("columns-container");

    // al entrar en nivel 0, sustituye el root
    if(level===0) container.innerHTML = "";

    const col = document.createElement("div");
    col.className="column";

    if(level===0){
      const bar = document.createElement("div");
      bar.className="column-header";
      const back = document.createElement("button");
      back.className="back-only";
      back.innerHTML = BACK_CHEVRON_SVG;
      back.onclick = () => renderRootMenu();
      const title = document.createElement("div");
      title.textContent="Todas las categor√≠as";
      bar.appendChild(back);
      bar.appendChild(title);
      col.appendChild(bar);
    updateDrawerWidth();
  } else if(parentItem){
      const h = document.createElement("div");
      h.className="column-header";
      h.textContent = displayName(parentItem.name);

      const a = document.createElement("a");
      a.className="view-all";
      a.href = "#" + slugifyPath(parentItem.path || parentItem.name);
      a.textContent = "Ver " + displayName(parentItem.name);

      col.appendChild(h);
      col.appendChild(a);

      const bChild = findBanner({scope:"category_children", parent: parentItem.name});
      const childCard = renderBannerCard(bChild, "small");
      if(childCard) col.appendChild(childCard);

    }

    const ul = document.createElement("ul");

    items.forEach(item=>{
      const hasChild = item.children && item.children.length>0;
      const li = document.createElement("li");
      li.className="item";

      const icon = (level===0) ? getIconForFirstLevel(item.name) : "";
      li.innerHTML =
        `<span class="label">${icon ? `<span class="icon">${icon}</span>` : ""}<span class="text">${displayName(item.name)}</span></span>` +
        `${hasChild ? CHEVRON_SVG : ""}`;

      // ‚úÖ Toggle: si vuelves a clicar la misma categor√≠a con hijos, cierra el nivel a la derecha
      li.onclick = () => {
        const wasActive = li.classList.contains("active");

        // borra columnas a la derecha siempre
        const cols = Array.from(container.querySelectorAll(".column"));
        cols.slice(level+1).forEach(c=>c.remove());

        if (hasChild && wasActive) {
          li.classList.remove("active");
          updateDrawerWidth();
          return;
        }

        // activar en esta columna
        Array.from(ul.children).forEach(el=>el.classList.remove("active"));
        li.classList.add("active");

        if (hasChild) {
          render(item.children, level+1, item);
        }
        updateDrawerWidth();
      };

      ul.appendChild(li);

      if(parentItem){
        const bAfter = findBanner({scope:"after_item", parent: parentItem.name, after: item.name});
        const afterCard = renderBannerCard(bAfter, "small");
        if(afterCard){
          const liB = document.createElement('li');
          liB.style.borderBottom='none';
          liB.appendChild(afterCard);
          ul.appendChild(liB);
        }
      }

    });

    col.appendChild(ul);

    const bRoot = findBanner({scope:"root"});
    const rootCard = renderBannerCard(bRoot, "");
    if(rootCard) col.appendChild(rootCard);

    container.appendChild(col);
  }


</script>
</body>
</html>

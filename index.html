<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menu Mockup - Test de encontrabilidad</title>
  <style>
    :root{ --brand:#034ca8; --border:#e6e8eb; --bg:#f4f6f9; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);overflow:hidden}
    header{background:#fff;height:60px;display:flex;align-items:center;padding:0 20px;border-bottom:1px solid var(--border)}
    .hamburger{width:42px;height:42px;border:1px solid var(--border);background:#fff;cursor:pointer;border-radius:8px;font-size:20px;color:var(--brand)}
    #overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1000}
    #drawer{position:fixed;inset:0 auto 0 0;background:#fff;z-index:1001;display:none;flex-direction:column;box-shadow:10px 0 30px rgba(0,0,0,.12);width:auto;max-width:96vw}
    .drawer-header{padding:15px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-weight:900;color:var(--brand)}
    .close-x{border:none;background:none;cursor:pointer;font-size:18px;line-height:1}
    #status{padding:10px;text-align:center;font-size:12px;background:#fff3cd;display:none}
    #columns-container{display:flex;flex:1;overflow-x:auto;overflow-y:hidden;background:#fff;scrollbar-width:none;-ms-overflow-style:none}
    .column{flex:0 0 330px;border-right:1px solid #eee;overflow-y:auto;height:100%}
    @media (max-width:520px){.column{flex-basis:86vw}}
    ul{list-style:none;padding:0;margin:0}
    .item{padding:14px 20px;display:flex;justify-content:space-between;align-items:center;gap:10px;cursor:pointer;font-size:13px;border-bottom:1px solid #f3f4f6}
    .item:hover{background:#f7f9fc;color:var(--brand)}
    .item.active{background:#e6f2fa;color:var(--brand);font-weight:800;border-left:5px solid var(--brand)}
    .label{display:flex;align-items:center;gap:10px;min-width:0}
    .text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .icon{width:22px;height:22px;display:inline-grid;place-items:center;font-size:18px;flex:0 0 auto}
    .chevron{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;flex:0 0 auto}
    .chevron svg{width:18px;height:18px;stroke:var(--brand);stroke-width:2.6;fill:none;stroke-linecap:round;stroke-linejoin:round}
    .column-header{padding:14px 16px 8px;font-weight:900;color:var(--brand);font-size:18px;display:flex;align-items:center;gap:10px}
    .back-only{border:none;background:transparent;padding:0;cursor:pointer;display:inline-flex;align-items:center}
    .divider{border-top:1px solid #e5e7eb;margin:8px 0;}
    .promo-card{ margin:16px; border-radius:14px; overflow:hidden; position:relative; background:#f0f0f0; box-shadow:0 10px 25px rgba(0,0,0,.1); }
    .promo-img{ width:100%; height:160px; object-fit:cover; display:block; }
    .promo-link{ position:absolute; inset:0; display:block; }
    .promo-card.small{ margin:12px 16px 8px; }
    .promo-card.small .promo-img{ height:120px; }

    /* overlays */
    #abpanel * { box-sizing:border-box; }
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .btn{
      padding:10px;border-radius:12px;border:1px solid var(--border);
      font-weight:900;cursor:pointer;
    }
    .btnPrimary{background:var(--brand);color:#fff;}
    .btnGhost{background:#fff;color:#111;}
  </style>
</head>
<body>

<header>
  <button class="hamburger" id="openBtn">‚ò∞</button>
  <div style="margin-left:15px;font-weight:900;color:var(--brand);">MENU MOCKUP</div>
</header>

<!-- ===== Intro Panel Grande ===== -->
<div id="introOverlay" style="position:fixed; inset:0; z-index:4000; background:rgba(0,0,0,.55);">
  <div style="
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    background:#fff; border:1px solid var(--border); border-radius:18px;
    width:min(780px,92vw); padding:18px; box-shadow:0 24px 60px rgba(0,0,0,.28);">
    <div style="font-weight:1000;font-size:20px;color:var(--brand);">Test de encontrabilidad del men√∫</div>
    <div style="margin-top:10px;color:#222;line-height:1.4;font-size:13px;">
      <b>Qu√© tienes que hacer:</b>
      <ol style="margin:8px 0 0 18px;">
        <li>Pulsa <b>Empezar</b>.</li>
        <li>Para cada tarea, navega por el men√∫ hasta encontrar la <b>ruta correcta</b>.</li>
        <li>Cuando llegues, saldr√° un cartel: <b>‚ÄúEs la correcta‚Äù</b> y pasar√° a la siguiente tarea.</li>
        <li>Si te interrumpen, puedes <b>Pausar</b> y luego <b>Reanudar</b>.</li>
        <li>Al terminar la √∫ltima tarea, el CSV se <b>descargar√° autom√°ticamente</b>.</li>
      </ol>
      <div style="margin-top:10px;color:#555;">
        Consejo: no hace falta ‚Äúadivinar‚Äù. Solo navega como lo har√≠as normalmente.
      </div>
    </div>

    <div style="margin-top:14px; padding:12px; border:1px dashed #cfd6df; border-radius:14px; background:#fbfcfe;">
      <div style="font-weight:900;margin-bottom:6px;">Tareas incluidas</div>
      <ul id="introTaskList" style="margin:0 0 0 18px; color:#333; font-size:13px;"></ul>
      <div style="margin-top:8px; color:#666; font-size:11px;">
        * Las rutas objetivo est√°n definidas dentro del c√≥digo en <code>TASKS</code> ‚Üí <code>route:[...]</code>.
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-top:14px;">
      <button id="btnIntroStart" class="btn btnPrimary" style="flex:1;">Empezar</button>
      <button id="btnIntroClose" class="btn btnGhost" style="flex:1;">Cerrar (sin empezar)</button>
    </div>
  </div>
</div>
<!-- ============================ -->

<!-- ===== Panel peque√±o (control) ===== -->
<div id="abpanel" style="
  position:fixed; top:10px; right:10px; z-index:2000;
  background:#fff; border:1px solid var(--border); border-radius:12px;
  padding:10px; box-shadow:0 10px 25px rgba(0,0,0,.12);
  font-size:12px; width:420px; max-width:92vw; display:none;">
  <div style="font-weight:900;color:var(--brand);margin-bottom:6px;">Test en curso</div>

  <div style="display:flex; gap:8px; margin-bottom:6px;">
    <button id="btnPause" class="btn btnGhost" style="flex:1;">‚è∏ Pausa</button>
    <button id="btnResume" class="btn btnPrimary" style="flex:1; display:none;">‚ñ∂ Reanudar</button>
  </div>

  <div style="font-weight:900; margin-bottom:6px;">
    Tarea: <span id="taskNowLabel" style="color:var(--brand);"></span>
  </div>

  <div id="taskGoal" style="margin-top:4px;color:#111;"></div>
  <div id="taskInfo" style="margin-top:6px;color:#555; line-height:1.35;"></div>

  <div id="taskHint" style="margin-top:8px;color:#555;"></div>
  <div id="taskTimer" style="margin-top:6px;font-weight:900;"></div>

  <div style="margin-top:8px; font-size:11px; color:#444;">
    Ruta actual: <code id="pathNow" style="display:inline-block; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; vertical-align:bottom;"></code>
  </div>

  <div id="taskLast" style="margin-top:8px;color:#666;font-size:11px;"></div>

  <div style="display:flex; gap:8px; margin-top:10px;">
    <button id="btnFailTask" class="btn btnGhost" style="flex:1;">No lo encuentro</button>
    <button id="btnDownloadCSV" class="btn btnGhost" style="flex:1;">Descargar CSV</button>
  </div>

  <div style="display:flex; gap:8px; margin-top:8px;">
    <button id="btnResetLog" class="btn btnGhost" style="flex:1;">Borrar log</button>
    <button id="btnRestartTasks" class="btn btnGhost" style="flex:1;">Reiniciar tareas</button>
  </div>
</div>
<!-- =============================== -->

<!-- ===== Cartel de tarea completada ===== -->
<div id="doneOverlay" style="position:fixed; inset:0; z-index:3000; display:none; background:rgba(0,0,0,.55);">
  <div style="
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    background:#fff; border:1px solid var(--border); border-radius:16px;
    width:min(560px,92vw); padding:18px; box-shadow:0 20px 50px rgba(0,0,0,.25);
    text-align:center;">
    <div style="font-weight:1000;font-size:18px;color:var(--brand);">‚úÖ Es la correcta</div>
    <div id="doneDetail" style="margin-top:8px;color:#333;font-size:13px; white-space:pre-line;"></div>
    <div id="doneTime" style="margin-top:10px;font-weight:900;"></div>

    <div style="display:flex; gap:10px; margin-top:14px;">
      <button id="btnNextTask" class="btn btnPrimary" style="flex:1;">Siguiente tarea</button>
    </div>

    <div style="margin-top:10px; font-size:11px; color:#666;">
      Al terminar la √∫ltima tarea se descargar√° el CSV autom√°ticamente.
    </div>
  </div>
</div>
<!-- ====================================== -->

<div id="overlay"></div>

<aside id="drawer">
  <div class="drawer-header">
    <span>MENU</span>
    <button class="close-x" id="closeBtn">‚úï</button>
  </div>
  <div id="status"></div>
  <div id="columns-container"></div>
</aside>

<script>
  const SHEET_ID = "1rG-kDB8Srrn-dIldsFuc7rwAc7q2EuNy4CHfz2kvDTY";
  const GID_CATEGORIES = "0";
  const GID_BANNERS = "1300813141";

  const DATA_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_CATEGORIES}&_=${Date.now()}`;
  const BANNERS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_BANNERS}&_=${Date.now()}`;

  const CHEVRON_SVG = `<span class="chevron"><svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg></span>`;
  const BACK_CHEVRON_SVG = `<span class="chevron" style="transform:rotate(180deg)"><svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg></span>`;

  const TOP_ORDER = ["Camillas", "Mobiliario", "Sillas de ruedas", "Aparatolog√≠a y equipos", "Esterilizaci√≥n y autoclaves", "Material m√©dico", "Cuidado personal y salud", "Desechables y consumibles", "Ayudas t√©cnicas para personas mayores", "Vestuario y seguridad"];
  const ICON_MAP = {"aparatologia y equipos":"üìÅ", "ayudas tecnicas para personas mayores":"üßì", "camillas":"üõèÔ∏è", "cuidado personal y salud":"üß¥", "desechables y consumibles":"üßª", "diagnostico":"ü©∫", "esterilizacion y autoclaves":"üßº", "instrumental":"üß∞", "material medico":"üì¶", "mobiliario":"ü™ë", "sillas de ruedas":"ü¶Ω", "vestuario y seguridad":"ü¶∫"};
  const FEATURED_CATS = [{ name:"Camillas", tag:"trending" }, { name:"Sillas de ruedas", tag:"new" }, { name:"Diagn√≥stico", tag:null }, { name:"Mobiliario", tag:null }];
  const SPECIALTIES_ITEMS = [{ name:"Fisioterapia", icon:"ü¶µ" }, { name:"Est√©tica", icon:"‚ú®" }, { name:"Peluquer√≠a y Barber√≠a", icon:"üíà" }, { name:"SPA & Wellness", icon:"üßñ" }, { name:"Medicina", icon:"ü©∫" }];
  const OFFERS_ITEMS = [{ name:"Ofertas del momento" }, { name:"M√°s vendidos" }, { name:"Promociones" }];

  // ===================== TEST (ruta exacta) =====================
  const VERSION = "FIN";
  const SESSION_ID = (crypto?.randomUUID) ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2);

  // ‚úÖ AQU√ç PONES TUS RUTAS EXACTAS en route:[...]
  const TASKS = [
    {
      id:"camilla_electrica",
      label:"Camilla el√©ctrica",
      route:["Camillas","Camillas el√©ctricas"], // <-- EDITA AQU√ç
      goal:"Encuentra la categor√≠a de camillas el√©ctricas en el men√∫.",
      info:"Camilla el√©ctrica: camilla cl√≠nica con motor para ajustar altura/secciones; se usa en fisioterapia, cl√≠nica y exploraci√≥n."
    },
    {
      id:"silla_ruedas_electrica",
      label:"Silla de ruedas el√©ctrica",
      route:["Sillas de ruedas","Sillas de ruedas el√©ctricas"], // <-- EDITA AQU√ç
      goal:"Encuentra la categor√≠a de sillas de ruedas el√©ctricas en el men√∫.",
      info:"Silla de ruedas el√©ctrica: motor y bater√≠a, control por joystick, pensada para movilidad reducida."
    },
    {
      id:"autoclave_clase_b",
      label:"Autoclave clase B",
      route:["Esterilizaci√≥n y autoclaves","Autoclaves clase B"], // <-- EDITA AQU√ç
      goal:"Encuentra la categor√≠a de autoclaves clase B en el men√∫.",
      info:"Autoclave clase B: esterilizador de vapor con prevac√≠o/postvac√≠o, apto para instrumental hueco/poroso (dental, cl√≠nica, est√©tica avanzada)."
    }
  ];

  let taskIndex = 0;
  let TASK = null;

  let START_TS = 0;
  let PAUSED = false;
  let PAUSE_TS = 0;
  let PAUSED_TOTAL_MS = 0;

  let CLICK_PATH = [];
  let TIMER_INT = null;
  let TASK_DONE = false;

  const EVENTS = [];
  let TEST_STARTED = false;

  function norm2(s){
    return String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
  }
  function nowISO(){ return new Date().toISOString(); }

  function effectiveElapsedMs(){
    if(!START_TS) return 0;
    const now = PAUSED ? PAUSE_TS : Date.now();
    return Math.max(0, (now - START_TS) - PAUSED_TOTAL_MS);
  }

  function setPathNow(){
    const el = document.getElementById("pathNow");
    if (el) el.textContent = CLICK_PATH.join(" > ");
  }

  function setTaskUI(){
    const lbl = document.getElementById("taskNowLabel");
    const goal = document.getElementById("taskGoal");
    const info = document.getElementById("taskInfo");
    const hint = document.getElementById("taskHint");
    const timer = document.getElementById("taskTimer");

    if (lbl) lbl.textContent = TASK ? `${taskIndex+1}/${TASKS.length} ¬∑ ${TASK.label}` : "(sin tarea)";
    if (goal) goal.innerHTML = TASK ? `<b>Qu√© buscar:</b> ${TASK.goal}` : "";
    if (info) info.innerHTML = TASK ? `<b>Info:</b> ${TASK.info}` : "";
    if (hint) hint.textContent = TASK ? `Objetivo (ruta): ${TASK.route.join(" > ")}` : "";
    if (timer) timer.textContent = "Tiempo: 0.0s";
    setPathNow();
  }

  function track(eventName, extra = {}) {
    const row = {
      ts_iso: nowISO(),
      version: VERSION,
      session_id: SESSION_ID,
      task_id: TASK?.id || "",
      task_label: TASK?.label || "",
      target_route: TASK?.route ? TASK.route.join(" > ") : "",
      event: eventName,
      label: extra.label || "",
      level: (typeof extra.level === "number") ? extra.level : "",
      path: extra.path || CLICK_PATH.join(" > "),
      ms_from_start: START_TS ? effectiveElapsedMs() : "",
      url: location.href
    };
    EVENTS.push(row);

    const last = document.getElementById("taskLast");
    if (last) last.textContent = `√öltimo: ${row.event}${row.label ? " ‚Üí " + row.label : ""}`;
  }

  function startCurrentTask(){
    TASK = TASKS[taskIndex] || null;
    CLICK_PATH = [];
    TASK_DONE = false;

    START_TS = Date.now();
    PAUSED = false;
    PAUSE_TS = 0;
    PAUSED_TOTAL_MS = 0;

    setTaskUI();
    track("task_start");

    const btnPause = document.getElementById("btnPause");
    const btnResume = document.getElementById("btnResume");
    if (btnPause) btnPause.style.display = "block";
    if (btnResume) btnResume.style.display = "none";

    const timer = document.getElementById("taskTimer");
    if (TIMER_INT) clearInterval(TIMER_INT);
    TIMER_INT = setInterval(() => {
      if (!START_TS || !timer) return;
      timer.textContent = "Tiempo: " + (effectiveElapsedMs()/1000).toFixed(1) + "s" + (PAUSED ? " (pausa)" : "");
    }, 100);
  }

  function finishAllTasks(){
    TASK = null;
    START_TS = 0;
    if (TIMER_INT) clearInterval(TIMER_INT);
    track("tasks_finished");

    // descarga autom√°tica
    downloadCSV(true);
  }

  function nextTask(){
    taskIndex++;
    if (taskIndex >= TASKS.length) {
      finishAllTasks();
      return;
    }
    toggleMenu(true);
    startCurrentTask();
  }

  function failTask(){
    if(!TASK || !START_TS) return;
    track("task_fail");
    showCompletedBanner("‚ùå Marcada como 'No lo encuentro'");
  }

  function pauseTask(){
    if (!TASK || !START_TS || PAUSED) return;
    PAUSED = true;
    PAUSE_TS = Date.now();
    track("task_pause");
    document.getElementById("btnPause").style.display = "none";
    document.getElementById("btnResume").style.display = "block";
  }

  function resumeTask(){
    if (!TASK || !START_TS || !PAUSED) return;
    PAUSED = false;
    PAUSED_TOTAL_MS += (Date.now() - PAUSE_TS);
    PAUSE_TS = 0;
    track("task_resume");
    document.getElementById("btnPause").style.display = "block";
    document.getElementById("btnResume").style.display = "none";
  }

  function isSuccessPath(){
    if(!TASK || !START_TS || !TASK.route || !TASK.route.length) return false;
    const current = CLICK_PATH.map(norm2);
    const target = TASK.route.map(norm2);
    if (current.length < target.length) return false;

    for (let i = 0; i < target.length; i++) {
      const curVal = current[current.length - target.length + i];
      const tarVal = target[i];
      if (curVal !== tarVal) return false;
    }
    return true;
  }

  function escapeCSV(v){
    const s = String(v ?? "");
    if (/[",\n\r]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }

  function downloadCSV(isAuto=false){
    if (!EVENTS.length) {
      alert("No hay eventos todav√≠a.");
      return;
    }
    const headers = Object.keys(EVENTS[0]);
    const lines = [
      headers.join(","),
      ...EVENTS.map(r => headers.map(h => escapeCSV(r[h])).join(","))
    ];
    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    const ts = new Date().toISOString().replace(/[:.]/g,"-");
    a.href = URL.createObjectURL(blob);
    a.download = `menu_test_${VERSION}_${SESSION_ID}_${ts}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);

    if (isAuto) {
      // aviso final bonito
      alert("‚úÖ Test finalizado. Se ha descargado el CSV autom√°ticamente.");
    }
  }

  function resetLog(){
    EVENTS.length = 0;
    alert("Log borrado.");
  }

  function restartTasks(){
    taskIndex = 0;
    toggleMenu(true);
    startCurrentTask();
  }

  function showCompletedBanner(message){
    const overlayEl = document.getElementById("doneOverlay");
    const detail = document.getElementById("doneDetail");
    const timeEl = document.getElementById("doneTime");

    const seconds = START_TS ? (effectiveElapsedMs()/1000).toFixed(1) : "";
    const routeStr = CLICK_PATH.join(" > ");

    if (detail) detail.textContent = `${message}\nRuta: ${routeStr}`;
    if (timeEl) timeEl.textContent = seconds ? `Tiempo: ${seconds}s` : "";
    if (overlayEl) overlayEl.style.display = "block";
  }

  function hideCompletedBanner(){
    const overlayEl = document.getElementById("doneOverlay");
    if (overlayEl) overlayEl.style.display = "none";
  }
  // ============================================================

  // ===== Intro list =====
  function fillIntroList(){
    const ul = document.getElementById("introTaskList");
    if (!ul) return;
    ul.innerHTML = "";
    TASKS.forEach((t, i) => {
      const li = document.createElement("li");
      li.textContent = `${i+1}. ${t.label} ‚Äî ${t.goal}`;
      ul.appendChild(li);
    });
  }
  fillIntroList();

  // ===== Start flow =====
  function beginTest(){
    TEST_STARTED = true;
    document.getElementById("introOverlay").style.display = "none";
    document.getElementById("abpanel").style.display = "block";
    toggleMenu(true);
    // el men√∫ carga al abrir; cuando termine loadAllData inicia tarea autom√°ticamente si TEST_STARTED
  }

  document.getElementById("btnIntroStart").onclick = () => beginTest();
  document.getElementById("btnIntroClose").onclick = () => {
    document.getElementById("introOverlay").style.display = "none";
    // no empezamos
  };

  // Panel buttons
  document.getElementById("btnFailTask").onclick = () => failTask();
  document.getElementById("btnDownloadCSV").onclick = () => downloadCSV(false);
  document.getElementById("btnResetLog").onclick = () => resetLog();
  document.getElementById("btnRestartTasks").onclick = () => restartTasks();
  document.getElementById("btnPause").onclick = () => pauseTask();
  document.getElementById("btnResume").onclick = () => resumeTask();

  document.getElementById("btnNextTask").onclick = () => {
    hideCompletedBanner();
    nextTask();
  };
  document.getElementById("doneOverlay").onclick = (e) => {
    if (e.target && e.target.id === "doneOverlay") {
      hideCompletedBanner();
      nextTask();
    }
  };

  // ===== Menu data + render =====
  let menuTree = [];
  let bannersData = [];

  const drawer = document.getElementById("drawer");
  const overlay = document.getElementById("overlay");
  const statusEl = document.getElementById("status");

  document.getElementById("openBtn").onclick = () => toggleMenu(true);
  document.getElementById("closeBtn").onclick = () => toggleMenu(false);
  overlay.onclick = () => toggleMenu(false);

  const norm = (s) => String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
  const displayName = (name) => String(name||"").replace(/\s+Total\s*$/i,"").trim();

  async function loadAllData(){
    statusEl.style.display="block";
    statusEl.textContent="Cargando...";
    try {
      const [catRes, banRes] = await Promise.all([fetch(DATA_URL), fetch(BANNERS_URL)]);
      const catCsv = await catRes.text();
      const banCsv = await banRes.text();
      buildTree(catCsv);
      bannersData = rowsToObjects(parseCSV(banCsv)).reverse();
      statusEl.style.display="none";
      renderRootMenu();

      // SOLO iniciamos tarea si el usuario ha pulsado "Empezar"
      if (TEST_STARTED && !TASK) startCurrentTask();
    } catch(e) { statusEl.textContent="Error de carga"; }
  }

  function parseCSV(text){
    const rows = [];
    let cur = "", row = [], inQ = false;
    for (let i=0;i<text.length;i++){
      const ch = text[i];
      if (ch === '"') inQ = !inQ;
      else if (ch === ',' && !inQ){ row.push(cur); cur=""; }
      else if ((ch === '\n' || ch === '\r') && !inQ){
        row.push(cur); cur="";
        if (row.join("").trim()) rows.push(row);
        row=[];
      } else cur += ch;
    }
    row.push(cur); if(row.join("").trim()) rows.push(row);
    return rows;
  }

  function rowsToObjects(rows){
    if(!rows.length) return [];
    const header = rows[0].map(h => h.trim().toLowerCase());
    return rows.slice(1).map(row => {
      const obj = {};
      header.forEach((h, i) => obj[h] = (row[i] || "").trim());
      return obj;
    });
  }

  function buildTree(csv){
    const root = [];
    csv.split(/\r?\n/).forEach(line => {
      const clean = line.replace(/"/g, "").trim();
      if(!clean) return;
      const parts = clean.split(">").map(p => p.trim()).filter(Boolean);
      let current = root;
      parts.forEach((rawName) => {
        const name = displayName(rawName);
        let node = current.find(n => n.name === name);
        if(!node){
          node = {name, children: []};
          current.push(node);
        }
        current = node.children;
      });
    });
    sortNodes(root, 0);
    menuTree = root;
  }

  function sortNodes(nodes, level) {
    if (!nodes) return;
    if (level === 0) {
      const rank = new Map(TOP_ORDER.map((n, i) => [norm(n), i]));
      nodes.sort((a, b) => (rank.has(norm(a.name)) ? rank.get(norm(a.name)) : 999) - (rank.has(norm(b.name)) ? rank.get(norm(b.name)) : 999) || a.name.localeCompare(b.name));
    } else {
      nodes.sort((a, b) => a.name.localeCompare(b.name));
    }
    nodes.forEach(n => sortNodes(n.children, level + 1));
  }

  function renderRootMenu(){
    const container = document.getElementById("columns-container");
    container.innerHTML = "";
    const col = document.createElement("div");
    col.className = "column";

    col.innerHTML = `<ul>
      <li class="item" onclick="renderSpecialties()"><span class="label"><span class="icon">‚≠ê</span><span class="text">Especialidades</span></span>${CHEVRON_SVG}</li>
      <li class="item" onclick="renderOffers()"><span class="label"><span class="icon">üè∑Ô∏è</span><span class="text">Ofertas</span></span>${CHEVRON_SVG}</li>
      <li class="item" onclick="renderAllCategories()"><span class="label"><span class="icon">üìÅ</span><span class="text">Todas las categor√≠as</span></span>${CHEVRON_SVG}</li>
      <li class="divider"></li>
      ${FEATURED_CATS.map(fc => `<li class="item"><span class="label"><span class="text">${fc.name}</span></span></li>`).join('')}
    </ul>`;

    const b = bannersData.find(b => norm(b.scope) === 'root');
    if(b) col.innerHTML += `<div class="promo-card"><img class="promo-img" src="${b.img}"><a class="promo-link" href="${b.href||'#'}"></a></div>`;

    container.appendChild(col);
    updateDrawerWidth();
  }

  function renderSpecialties(){
    const container = document.getElementById("columns-container");
    container.innerHTML = "";
    const col = document.createElement("div");
    col.className = "column";
    col.innerHTML = `<div class="column-header"><button class="back-only" onclick="renderRootMenu()">${BACK_CHEVRON_SVG}</button> Especialidades</div><ul>
      ${SPECIALTIES_ITEMS.map(it => `<li class="item"><span class="label"><span class="icon">${it.icon}</span><span class="text">${it.name}</span></span></li>`).join('')}
    </ul>`;
    container.appendChild(col);
    updateDrawerWidth();
  }

  function renderOffers(){
    const container = document.getElementById("columns-container");
    container.innerHTML = "";
    const col = document.createElement("div");
    col.className = "column";
    col.innerHTML = `<div class="column-header"><button class="back-only" onclick="renderRootMenu()">${BACK_CHEVRON_SVG}</button> Ofertas</div><ul>
      ${OFFERS_ITEMS.map(it => `<li class="item"><span class="label"><span class="text">${it.name}</span></span></li>`).join('')}
    </ul>`;
    container.appendChild(col);
    updateDrawerWidth();
  }

  function renderAllCategories(){
    render(menuTree, 0);
  }

  function render(items, level, parent=null){
    const container = document.getElementById("columns-container");
    if(level === 0) container.innerHTML = "";
    else Array.from(container.querySelectorAll(".column")).slice(level).forEach(c => c.remove());

    const col = document.createElement("div");
    col.className = "column";
    col.innerHTML = `<div class="column-header">${level===0 ? `<button class="back-only" onclick="renderRootMenu()">${BACK_CHEVRON_SVG}</button> Todas las categor√≠as` : parent.name}</div><ul></ul>`;
    const ul = col.querySelector("ul");

    items.forEach(item => {
      const li = document.createElement("li");
      li.className = "item";
      const icon = level === 0 ? (ICON_MAP[norm(item.name)] || "") : "";
      li.innerHTML = `<span class="label">${icon?`<span class="icon">${icon}</span>`:""}<span class="text">${item.name}</span></span>${item.children.length?CHEVRON_SVG:''}`;

      li.onclick = () => {
        // ===== tracking (solo si test started + tarea activa + no pausa) =====
        if (TEST_STARTED && TASK && START_TS && !TASK_DONE && !PAUSED) {
          CLICK_PATH.push(item.name);
          setPathNow();
          track("click_item", { label: item.name, level });

          if (isSuccessPath()) {
            TASK_DONE = true;
            track("task_success", { label: item.name, level, path: CLICK_PATH.join(" > ") });
            showCompletedBanner("‚úÖ Ruta correcta");
          }
        }
        // ================================================================

        const wasActive = li.classList.contains("active");
        Array.from(ul.children).forEach(l => l.classList.remove("active"));

        if(item.children.length && wasActive) {
          Array.from(container.querySelectorAll(".column")).slice(level+1).forEach(c => c.remove());
          li.classList.remove("active");
        } else {
          li.classList.add("active");
          if(item.children.length) render(item.children, level + 1, item);
        }
        updateDrawerWidth();
      };

      ul.appendChild(li);
    });

    container.appendChild(col);
    updateDrawerWidth();
  }

  function toggleMenu(open){
    if (TEST_STARTED) track(open ? "menu_open" : "menu_close");
    drawer.style.display = open ? "flex" : "none";
    overlay.style.display = open ? "block" : "none";
    if(open && menuTree.length===0) loadAllData();
    else if(open) renderRootMenu();
  }

  function updateDrawerWidth(){
    const count = document.querySelectorAll(".column").length;
    drawer.style.width = Math.min(count * 330, window.innerWidth * 0.95) + "px";
  }
</script>
</body>
</html>

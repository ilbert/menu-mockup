<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menu Mockup</title>
  <style>
    :root{
      --brand:#034ca8;
      --border:#e6e8eb;
      --bg:#f4f6f9;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);overflow:hidden}
    header{background:#fff;height:60px;display:flex;align-items:center;padding:0 20px;border-bottom:1px solid var(--border)}
    .hamburger{width:42px;height:42px;border:1px solid var(--border);background:#fff;cursor:pointer;border-radius:8px;font-size:20px;color:var(--brand)}
    #overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1000}
    #drawer{position:fixed;inset:0 auto 0 0;background:#fff;z-index:1001;display:none;flex-direction:column;box-shadow:10px 0 30px rgba(0,0,0,.12);width:auto;max-width:96vw}
    .drawer-header{padding:15px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-weight:900;color:var(--brand)}
    .close-x{border:none;background:none;cursor:pointer;font-size:18px;line-height:1}
    #status{padding:10px;text-align:center;font-size:12px;background:#fff3cd; color: #856404; display: none;}

    /* scroll horizontal funcional pero sin barra visible */
    #columns-container{display:flex;flex:1;overflow-x:auto;overflow-y:hidden;background:#fff;scrollbar-width:none;-ms-overflow-style:none}
    #columns-container::-webkit-scrollbar{height:0px}

    .column{flex:0 0 330px;border-right:1px solid #eee;overflow-y:auto;height:100%}
    @media (max-width:520px){.column{flex-basis:86vw}}

    ul{list-style:none;padding:0;margin:0}
    .item{padding:14px 20px;display:flex;justify-content:space-between;align-items:center;gap:10px;cursor:pointer;font-size:13px;border-bottom:1px solid #f3f4f6}
    .item:hover{background:#f7f9fc;color:var(--brand)}
    .item.active{background:#e6f2fa;color:var(--brand);font-weight:800;border-left:5px solid var(--brand)}

    .label{display:flex;align-items:center;gap:10px;min-width:0}
    .text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .icon{width:22px;height:22px;display:inline-grid;place-items:center;font-size:18px;flex:0 0 auto}

    .chevron{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;flex:0 0 auto}
    .chevron svg{width:18px;height:18px;stroke:var(--brand);stroke-width:2.6;fill:none;stroke-linecap:round;stroke-linejoin:round}

    .column-header{padding:14px 16px 8px;font-weight:900;color:var(--brand);font-size:18px;display:flex;align-items:center;gap:10px}
    .view-all{display:block;padding:0 16px 12px;color:var(--brand);text-decoration:underline;font-weight:650;font-size:14px}
    .back-only{border:none;background:transparent;padding:0;cursor:pointer;display:inline-flex;align-items:center}

    .divider{border-top:1px solid #e5e7eb;margin:8px 0;}
    .tag{font-size:12px;font-weight:800;padding:2px 8px;border-radius:999px;margin-left:8px;white-space:nowrap}
    .tag.new{background:#e6f2fa;color:var(--brand)}
    .tag.trending{background:#eafaf1;color:#0a8f4e}

    /* Banner promo */
    .promo-card{
      margin:16px;
      border-radius:14px;
      overflow:hidden;
      position:relative;
      background:#0b5ed7;
      box-shadow:0 10px 25px rgba(0,0,0,.12);
    }
    .promo-img{
      width:100%;
      height:160px;
      object-fit:cover;
      display:block;
    }
    .promo-link{ position:absolute; inset:0; display:block; }
    .promo-card.small{ margin:12px 16px 8px; }
    .promo-card.small .promo-img{ height:120px; }
  </style>
</head>
<body>
<header>
  <button class="hamburger" id="openBtn">‚ò∞</button>
  <div style="margin-left:15px;font-weight:900;color:var(--brand);">MENU MOCKUP</div>
</header>

<div id="overlay"></div>

<aside id="drawer">
  <div class="drawer-header">
    <span>MENU</span>
    <button class="close-x" id="closeBtn" aria-label="Cerrar">‚úï</button>
  </div>
  <div id="status"></div>
  <div id="columns-container"></div>
</aside>

<script>
  // ====== CONFIGURACI√ìN CORREGIDA ======
  // ID extra√≠do de tu URL: 1rG-kDB8Srrn-dIldsFuc7rwAc7q2EuNy4CHfz2kvDTY
  const SHEET_ID = "1rG-kDB8Srrn-dIldsFuc7rwAc7q2EuNy4CHfz2kvDTY";
  
  // GID 0 = Generalmente es la "Hoja 1" (Categor√≠as)
  const GID_CATEGORIES = "0"; 
  
  // GID 1300813141 = Pesta√±a "banner" (Confirmado por tu link)
  const GID_BANNERS = "1300813141";

  // URLs de exportaci√≥n CSV
  const DATA_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?gid=${GID_CATEGORIES}&single=true&output=csv&_=${Date.now()}`;
  const BANNERS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?gid=${GID_BANNERS}&single=true&output=csv&_=${Date.now()}`;

  // Iconos SVG
  const CHEVRON_SVG = `<span class="chevron" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg></span>`;
  const BACK_CHEVRON_SVG = `<span class="chevron" aria-hidden="true" style="transform:rotate(180deg)"><svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg></span>`;

  // ====== Orden y Mapeos ======
  const TOP_ORDER = [
    "Camillas", "Mobiliario", "Sillas de ruedas", "Aparatolog√≠a y equipos",
    "Esterilizaci√≥n y autoclaves", "Material m√©dico", "Cuidado personal y salud",
    "Desechables y consumibles", "Ayudas t√©cnicas para personas mayores", "Vestuario y seguridad"
  ];

  const ICON_MAP = {
    "aparatologia y equipos":"üìÅ", "ayudas tecnicas para personas mayores":"üßì",
    "camillas":"üõèÔ∏è", "cuidado personal y salud":"üß¥", "desechables y consumibles":"üßª",
    "diagnostico":"ü©∫", "electrodomesticos y hogar":"üè†", "esterilizacion y autoclaves":"üßº",
    "instrumental":"üß∞", "material medico":"üì¶", "mobiliario":"ü™ë",
    "ofertas y campanas":"üè∑Ô∏è", "sillas de ruedas":"ü¶Ω", "vestuario y seguridad":"ü¶∫"
  };

  const ROOT_ICON_MAP = { "especialidades": "‚≠ê" };

  const OFFERS_ITEMS = [
    { name:"Ofertas del momento", children:[] },
    { name:"M√°s vendidos", children:[] },
    { name:"Promociones", children:[] }
  ];

  const FEATURED_CATS = [
    { name:"Camillas", tag:"trending" },
    { name:"Sillas de ruedas", tag:"new" },
    { name:"Diagn√≥stico", tag:null },
    { name:"Mobiliario", tag:null }
  ];

  const SPECIALTIES_ITEMS = [
    { name:"Fisioterapia", icon:"ü¶µ", children:[] },
    { name:"Est√©tica", icon:"‚ú®", children:[] },
    { name:"Peluquer√≠a y Barber√≠a", icon:"üíà", children:[] },
    { name:"SPA & Wellness", icon:"üßñ", children:[] },
    { name:"Medicina", icon:"ü©∫", children:[] }
  ];

  // ====== Helpers ======
  const norm = (s) => String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim().replace(/\s+/g," ");
  function displayName(name){ return String(name||"").replace(/\s+Total\s*$/i,"").trim(); }
  const getIconForFirstLevel = (name) => ICON_MAP[norm(displayName(name))] || "";
  
  function slugifyPath(s){
    return String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim()
      .replace(/\s+/g,"-").replace(/[^a-z0-9\-\/ >]+/g,"")
      .replace(/\s*>\s*/g,"/").replace(/\/+/g,"/").replace(/^-+|-+$/g,"");
  }

  function sortChildrenAlpha(nodes){
    nodes.forEach(n => {
      n.children.sort((a,b)=>displayName(a.name).localeCompare(displayName(b.name)));
      sortChildrenAlpha(n.children);
    });
  }

  function sortTopLevel(nodes){
    const rank = new Map(TOP_ORDER.map((n,i)=>[norm(n), i]));
    nodes.sort((a,b)=>{
      const ra = rank.has(norm(displayName(a.name))) ? rank.get(norm(displayName(a.name))) : 9999;
      const rb = rank.has(norm(displayName(b.name))) ? rank.get(norm(displayName(b.name))) : 9999;
      if(ra !== rb) return ra - rb;
      return displayName(a.name).localeCompare(displayName(b.name));
    });
  }

  // ====== Estado ======
  let menuTree = [];
  let banners = [];

  const drawer = document.getElementById("drawer");
  const overlay = document.getElementById("overlay");
  const statusEl = document.getElementById("status");

  document.getElementById("openBtn").onclick = () => toggleMenu(true);
  document.getElementById("closeBtn").onclick = () => toggleMenu(false);
  overlay.onclick = () => toggleMenu(false);

  function updateDrawerWidth(){
    const cols = document.querySelectorAll('#columns-container .column').length || 1;
    const colWidth = 330;
    const desired = cols * colWidth + 1;
    const maxW = Math.floor(window.innerWidth * 0.96);
    drawer.style.width = Math.min(desired, maxW) + "px";
  }

  window.addEventListener('resize', () => {
    if (drawer.style.display === 'flex') updateDrawerWidth();
  }, { passive: true });

  function toggleMenu(open){
    if(open){
      drawer.style.display="flex";
      drawer.style.width = "330px";
      overlay.style.display="block";
      if(menuTree.length===0) loadAllData();
      else renderRootMenu();
    } else {
      drawer.style.display="none";
      overlay.style.display="none";
      drawer.style.width = "";
    }
  }

  // ====== CSV Parsing ======
  function parseCSV(text){
    const rows = [];
    let cur = "", row = [], inQ = false;
    for (let i=0;i<text.length;i++){
      const ch = text[i];
      const nxt = text[i+1];
      if (ch === '"' ){
        if(inQ && nxt === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if (ch === ',' && !inQ){
        row.push(cur); cur="";
      } else if ((ch === '\n' || ch === '\r') && !inQ){
        if (ch === '\r' && nxt === '\n') i++;
        row.push(cur); cur="";
        if (row.some(v => String(v).trim() !== "")) rows.push(row);
        row=[];
      } else {
        cur += ch;
      }
    }
    row.push(cur);
    if (row.some(v => String(v).trim() !== "")) rows.push(row);
    return rows;
  }

  function rowsToObjects(rows){
    if(!rows.length) return [];
    const header = rows[0].map(h => String(h||"").trim());
    const out = [];
    for(let i=1;i<rows.length;i++){
      const obj = {};
      header.forEach((h, idx) => obj[h] = (rows[i][idx] ?? "").trim());
      if(Object.values(obj).some(v => v !== "")) out.push(obj);
    }
    return out;
  }

  // ====== Carga de datos ======
  async function loadAllData(){
    if (location.protocol === "file:") {
      statusEl.style.display="block";
      statusEl.innerHTML="‚ö†Ô∏è <b>Error:</b> Abre este archivo desde un servidor (GitHub Pages, localhost).<br>No funciona con doble click (file://).";
      return;
    }

    statusEl.style.display="block";
    statusEl.textContent="Cargando datos...";
    statusEl.style.background="#fff3cd"; 
    statusEl.style.color="#856404";

    try{
      const [catRes, banRes] = await Promise.all([fetch(DATA_URL), fetch(BANNERS_URL)]);
      
      // Chequeo de errores HTTP
      if(!catRes.ok) throw new Error(`Error ${catRes.status} al leer Categor√≠as`);
      if(!banRes.ok) throw new Error(`Error ${banRes.status} al leer Banners`);

      const catCsv = await catRes.text();
      const banCsv = await banRes.text();

      // Chequeo si devolvi√≥ HTML (significa que no est√° publicado o pide login)
      if(catCsv.trim().startsWith("<!doctype") || catCsv.trim().startsWith("<html")) {
        throw new Error("Google Sheets devolvi√≥ una p√°gina de Login/Error en lugar de CSV.<br><b>Aseg√∫rate de: Archivo > Compartir > Publicar en la web</b>");
      }

      buildTree(catCsv);

      const banRows = parseCSV(banCsv);
      banners = rowsToObjects(banRows).map(b => ({
        scope: (b.scope||"").trim(),
        parent: (b.parent||"").trim(),
        after: (b.after||"").trim(),
        img: (b.img||"").trim(),
        href: (b.href||"").trim(),
        title: (b.title||"").trim()
      })).filter(b => b.scope && b.img);

      statusEl.style.display="none";
      renderRootMenu();

    }catch(e){
      statusEl.style.display="block";
      statusEl.style.background = "#f8d7da";
      statusEl.style.color = "#721c24";
      statusEl.innerHTML = `‚ùå <b>Ocurri√≥ un error:</b><br>${e.message}`;
      console.error("Detalle del error:", e);
    }
  }

  function buildTree(csv){
    const root = [];
    const seen = new Set();
    const lines = csv.split(/\r?\n/);

    for (const line of lines) {
      const clean = line.replace(/"/g, "").trim();
      if (!clean) continue;
      // Separa por ">"
      const parts = clean.split(">").map(p => p.trim().replace(/\s+/g, " ")).filter(Boolean);
      if (parts.length < 1) continue;

      const key = parts.map(p => norm(displayName(p))).join(">");
      if (seen.has(key)) continue;
      seen.add(key);

      let current = root;
      parts.forEach((rawName, i) => {
        const name = displayName(rawName);
        let node = current.find(n => n.name === name);
        if (!node) {
          node = { name, children: [], path: parts.slice(0, i+1).map(displayName).join(" > ") };
          current.push(node);
        } else if (!node.path) {
          node.path = parts.slice(0, i+1).map(displayName).join(" > ");
        }
        current = node.children;
      });
    }

    menuTree = root;
    sortTopLevel(menuTree);
    sortChildrenAlpha(menuTree);
  }

  // ====== Banners ======
  function findBanner(query){
    const qScope = norm(query.scope || "");
    const qParent = norm(query.parent || "");
    const qAfter  = norm(query.after  || "");
    return banners.find(b => {
      if(norm(b.scope) !== qScope) return false;
      if(qParent && norm(b.parent) !== qParent) return false;
      if(qAfter  && norm(b.after)  !== qAfter)  return false;
      return true;
    }) || null;
  }

  function renderBannerCard(b, size){
    if(!b || !b.img) return null;
    const card = document.createElement("div");
    card.className = "promo-card" + (size === "small" ? " small" : "");
    const safeTitle = b.title ? b.title : "Promoci√≥n";
    const href = b.href ? b.href : "#";
    card.innerHTML = `<img class="promo-img" src="${b.img}" alt="${safeTitle}"><a class="promo-link" href="${href}"></a>`;
    return card;
  }

  // ====== Render Logic ======
  function renderRootMenu(){
    const container = document.getElementById("columns-container");
    container.innerHTML="";
    const col = document.createElement("div");
    col.className="column";
    const ul = document.createElement("ul");

    const rootItems = [
      { name:"Especialidades", type:"specialties" },
      { name:"Ofertas", type:"offers" },
      { name:"Todas las categor√≠as", type:"all" }
    ];

    rootItems.forEach(item => {
      const li = document.createElement("li");
      li.className="item";
      const rootIcon = (item.type==="specialties") ? (ROOT_ICON_MAP["especialidades"] || "") : "";
      li.innerHTML = `<span class="label">${rootIcon ? `<span class="icon">${rootIcon}</span>` : ""}<span class="text">${item.name}</span></span>${CHEVRON_SVG}`;
      li.onclick = () => {
        Array.from(ul.children).forEach(el=>el.classList.remove("active"));
        li.classList.add("active");
        if(item.type==="specialties") renderSpecialties();
        else if(item.type==="offers") renderOffers();
        else renderAllCategories();
        updateDrawerWidth();
      };
      ul.appendChild(li);
    });

    const div = document.createElement("li");
    div.className = "divider";
    ul.appendChild(div);

    FEATURED_CATS.forEach(fc => {
      const fli = document.createElement("li");
      fli.className = "item";
      fli.innerHTML = `<span class="label"><span class="text">${fc.name}</span>${fc.tag ? `<span class="tag ${fc.tag}">${fc.tag==="new"?"Nuevo":"Trending"}</span>` : ""}</span>`;
      ul.appendChild(fli);
    });

    col.appendChild(ul);
    // Banner Root
    const bRoot = findBanner({scope:"root"});
    const cardRoot = renderBannerCard(bRoot, "big");
    if(cardRoot) col.appendChild(cardRoot);

    container.appendChild(col);
    updateDrawerWidth();
  }

  function renderOffers(){
    const container = document.getElementById("columns-container");
    container.innerHTML="";
    const col = document.createElement("div");
    col.className="column";
    const bar = document.createElement("div");
    bar.className="column-header";
    const back = document.createElement("button");
    back.className="back-only";
    back.innerHTML = BACK_CHEVRON_SVG;
    back.onclick = () => renderRootMenu();
    bar.appendChild(back);
    bar.appendChild(document.createTextNode("Ofertas"));
    col.appendChild(bar);

    const ul = document.createElement("ul");
    OFFERS_ITEMS.forEach(it=>{
      const li=document.createElement("li");
      li.className="item";
      li.innerHTML = `<span class="label"><span class="text">${it.name}</span></span>`;
      ul.appendChild(li);
    });
    col.appendChild(ul);
    container.appendChild(col);
    updateDrawerWidth();
  }

  function renderSpecialties(){
    const container = document.getElementById("columns-container");
    container.innerHTML="";
    const col = document.createElement("div");
    col.className="column";
    const bar = document.createElement("div");
    bar.className="column-header";
    const back = document.createElement("button");
    back.className="back-only";
    back.innerHTML = BACK_CHEVRON_SVG;
    back.onclick = () => renderRootMenu();
    bar.appendChild(back);
    bar.appendChild(document.createTextNode("Especialidades"));
    col.appendChild(bar);

    const ul = document.createElement("ul");
    SPECIALTIES_ITEMS.forEach(it=>{
      const li=document.createElement("li");
      li.className="item";
      li.innerHTML = `<span class="label">${it.icon ? `<span class="icon">${it.icon}</span>` : ``}<span class="text">${it.name}</span></span>`;
      ul.appendChild(li);
    });
    col.appendChild(ul);
    container.appendChild(col);
    updateDrawerWidth();
  }

  function renderAllCategories(){
    render(menuTree, 0, null);
  }

  function render(items, level, parentItem=null){
    const container = document.getElementById("columns-container");
    if(level===0) container.innerHTML = "";

    const col = document.createElement("div");
    col.className="column";

    if(level===0){
      const bar = document.createElement("div");
      bar.className="column-header";
      const back = document.createElement("button");
      back.className="back-only";
      back.innerHTML = BACK_CHEVRON_SVG;
      back.onclick = () => renderRootMenu();
      bar.appendChild(back);
      bar.appendChild(document.createTextNode("Todas las categor√≠as"));
      col.appendChild(bar);
      updateDrawerWidth();
    } else if(parentItem){
      const h = document.createElement("div");
      h.className="column-header";
      h.textContent = displayName(parentItem.name);
      const a = document.createElement("a");
      a.className="view-all";
      a.href = "#" + slugifyPath(parentItem.path || parentItem.name);
      a.textContent = "Ver " + displayName(parentItem.name);
      col.appendChild(h);
      col.appendChild(a);

      const bChild = findBanner({scope:"category_children", parent: parentItem.name});
      if(bChild){
        const card = renderBannerCard(bChild, "small");
        if(card) col.appendChild(card);
      }
    }

    const ul = document.createElement("ul");

    items.forEach(item=>{
      const hasChild = item.children && item.children.length>0;
      const li = document.createElement("li");
      li.className="item";
      const icon = (level===0) ? getIconForFirstLevel(item.name) : "";
      
      li.innerHTML = `<span class="label">${icon ? `<span class="icon">${icon}</span>` : ""}<span class="text">${displayName(item.name)}</span></span>${hasChild ? CHEVRON_SVG : ""}`;

      li.onclick = () => {
        const wasActive = li.classList.contains("active");
        const cols = Array.from(container.querySelectorAll(".column"));
        cols.slice(level+1).forEach(c=>c.remove());

        if (hasChild && wasActive) {
          li.classList.remove("active");
          updateDrawerWidth();
          return;
        }

        Array.from(ul.children).forEach(el=>el.classList.remove("active"));
        li.classList.add("active");

        if (hasChild) {
          render(item.children, level+1, item);
        }
        updateDrawerWidth();
      };

      ul.appendChild(li);

      if(parentItem){
        const bAfter = findBanner({scope:"after_item", parent: parentItem.name, after: item.name});
        if(bAfter){
          const liBanner = document.createElement("li");
          liBanner.style.borderBottom = "none";
          const card = renderBannerCard(bAfter, "small");
          if(card){
            liBanner.appendChild(card);
            ul.appendChild(liBanner);
          }
        }
      }
    });

    col.appendChild(ul);
    container.appendChild(col);
    updateDrawerWidth();
  }
</script>
</body>
</html>
